name: Generate Daily Article

on:
  schedule:
    - cron: '0 6 * * *'  # Daily at 6 AM UTC
  workflow_dispatch:
    inputs:
      keyword:
        description: 'Target keyword (optional - auto-select if empty)'
        type: string
        required: false
      category:
        description: 'Article category'
        type: choice
        options:
          - auto
          - skincare
          - kitchen
          - organization
          - fitness
          - wellness
          - tech
          - budget
        default: auto
      publish:
        description: 'Publish immediately (false = draft only)'
        type: boolean
        default: false

jobs:
  generate:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    outputs:
      article_path: ${{ steps.generate.outputs.article_path }}
      keyword: ${{ steps.keyword.outputs.keyword }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install google-generativeai requests

      - name: Select keyword
        id: keyword
        run: |
          if [ -n "${{ github.event.inputs.keyword }}" ]; then
            KEYWORD="${{ github.event.inputs.keyword }}"
            CATEGORY="${{ github.event.inputs.category }}"
            if [ "$CATEGORY" = "auto" ]; then
              CATEGORY="general"
            fi
          else
            # Auto-select from keyword list
            RESULT=$(python automation/articles/keyword_selector.py --mark-used 2>&1)
            KEYWORD=$(echo "$RESULT" | grep "Selected keyword:" | cut -d: -f2- | xargs)
            CATEGORY=$(echo "$RESULT" | grep "Category:" | cut -d: -f2 | xargs)
          fi
          echo "keyword=$KEYWORD" >> $GITHUB_OUTPUT
          echo "category=$CATEGORY" >> $GITHUB_OUTPUT
          echo "Selected keyword: $KEYWORD"
          echo "Category: $CATEGORY"

      - name: Generate article
        id: generate
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          if [ -z "$GEMINI_API_KEY" ]; then
            echo "GEMINI_API_KEY not set, creating placeholder"
            mkdir -p articles/drafts
            echo "<html><body><h1>Placeholder: ${{ steps.keyword.outputs.keyword }}</h1></body></html>" > articles/drafts/placeholder.html
            echo "article_path=articles/drafts/placeholder.html" >> $GITHUB_OUTPUT
          else
            python automation/articles/article_generator.py \
              --keyword "${{ steps.keyword.outputs.keyword }}" \
              --category "${{ steps.keyword.outputs.category }}"

            # Find the generated file
            ARTICLE_FILE=$(ls -t articles/drafts/*.html 2>/dev/null | head -1)
            if [ -n "$ARTICLE_FILE" ]; then
              echo "article_path=$ARTICLE_FILE" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Upload draft for review
        uses: actions/upload-artifact@v4
        with:
          name: article-draft-${{ github.run_number }}
          path: articles/drafts/
          retention-days: 7

      - name: Create review issue
        if: github.event.inputs.publish != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue create \
            --title "ðŸ“ Review Article: ${{ steps.keyword.outputs.keyword }}" \
            --body "A new article has been generated and needs review.

          **Keyword:** ${{ steps.keyword.outputs.keyword }}
          **Category:** ${{ steps.keyword.outputs.category }}
          **Generated:** $(date)

          ### To Review:
          1. Download the article from [workflow artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          2. Review content for accuracy and quality
          3. If approved, run the publish workflow

          ### Quick Publish:
          If the article looks good, you can publish it by running:
          \`\`\`
          gh workflow run generate-article.yml -f keyword='${{ steps.keyword.outputs.keyword }}' -f publish=true
          \`\`\`
          " \
            --label "article-review"

  publish:
    runs-on: ubuntu-latest
    needs: generate
    if: github.event.inputs.publish == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download draft
        uses: actions/download-artifact@v4
        with:
          name: article-draft-${{ github.run_number }}
          path: articles/drafts/

      - name: Move to articles folder
        run: |
          # Move draft to main articles folder
          for file in articles/drafts/*.html; do
            if [ -f "$file" ] && [ "$file" != "articles/drafts/placeholder.html" ]; then
              mv "$file" articles/
              echo "Published: $(basename $file)"
            fi
          done

      - name: Update sitemap
        run: |
          # Add new article to sitemap
          NEW_ARTICLES=$(ls -t articles/*.html | head -3)
          echo "New articles to add to sitemap:"
          echo "$NEW_ARTICLES"
          # TODO: Run sitemap update script
          # python automation/articles/update_sitemap.py

      - name: Commit and push
        run: |
          git config user.name "Daily Deal Bot"
          git config user.email "bot@dailydealdarling.com"

          if git diff --quiet articles/; then
            echo "No new articles to commit"
          else
            git add articles/ sitemap.xml
            git commit -m "ðŸ“ Publish article: ${{ needs.generate.outputs.keyword }}"
            git push
          fi

      - name: Summary
        run: |
          echo "## Article Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Keyword:** ${{ needs.generate.outputs.keyword }}" >> $GITHUB_STEP_SUMMARY
          echo "**Path:** ${{ needs.generate.outputs.article_path }}" >> $GITHUB_STEP_SUMMARY
