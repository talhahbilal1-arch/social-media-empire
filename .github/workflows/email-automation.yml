name: Email Automation

on:
  schedule:
    # Run twice daily: 9 AM and 5 PM PST
    - cron: '0 17 * * *'  # 9 AM PST
    - cron: '0 1 * * *'   # 5 PM PST
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - process_sequences
          - send_newsletters
          - sync_subscribers
      brand:
        description: 'Specific brand (optional)'
        required: false
        type: string

env:
  PYTHON_VERSION: '3.11'

jobs:
  email-automation:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Process email sequences
        if: github.event.inputs.action == 'process_sequences' || github.event_name == 'schedule'
        env:
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          CONVERTKIT_API_KEY: ${{ secrets.CONVERTKIT_API_KEY }}
          CONVERTKIT_API_SECRET: ${{ secrets.CONVERTKIT_API_SECRET }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          python -c "
          from email_marketing.email_sender import get_email_sender
          from database.supabase_client import get_supabase_client

          sender = get_email_sender()
          db = get_supabase_client()

          # Get subscribers due for sequence emails
          # This is a placeholder - actual implementation would query
          # for subscribers at specific points in their sequence

          print('Email sequence processing completed')
          "

      - name: Sync subscribers to database
        if: github.event.inputs.action == 'sync_subscribers' || github.event_name == 'schedule'
        env:
          CONVERTKIT_API_KEY: ${{ secrets.CONVERTKIT_API_KEY }}
          CONVERTKIT_API_SECRET: ${{ secrets.CONVERTKIT_API_SECRET }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          python -c "
          from email_marketing.convertkit_setup.convertkit_automation import ConvertKitManager
          from database.supabase_client import get_supabase_client

          manager = ConvertKitManager()
          db = get_supabase_client()

          # Sync recent subscribers
          subscribers = manager.list_subscribers(page=1)
          total = subscribers.get('total_subscribers', 0)
          print(f'Total ConvertKit subscribers: {total}')
          "

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: email-automation-logs
          path: '*.log'
          retention-days: 7

  weekly-newsletter:
    runs-on: ubuntu-latest
    # Only run on Tuesdays at 10 AM PST (for Daily Deal Darling)
    if: github.event_name == 'schedule' && github.event.schedule == '0 17 * * 2'
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Send weekly newsletter
        env:
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          CONVERTKIT_API_KEY: ${{ secrets.CONVERTKIT_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          echo "Weekly newsletter would be sent here"
          # This would call the newsletter sending function
          # with the appropriate brand and template
