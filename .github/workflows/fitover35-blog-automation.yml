name: Fit Over 35 Blog Automation

on:
  schedule:
    # Run every Monday and Thursday at 9 AM UTC (generates ~2-3 articles each run = 5/week)
    - cron: '0 9 * * 1'   # Monday
    - cron: '0 9 * * 4'   # Thursday
  workflow_dispatch:
    inputs:
      num_articles:
        description: 'Number of articles to generate'
        required: false
        default: '3'

env:
  PYTHON_VERSION: '3.11'

jobs:
  generate-articles:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Social Media Empire repo
        uses: actions/checkout@v4
        with:
          path: social-media-empire

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install google-generativeai requests

      - name: Generate and publish articles
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.FITOVER35_GITHUB_TOKEN }}
        run: |
          cd social-media-empire
          python -c "
          import sys
          sys.path.insert(0, '.')
          from blog_automation.fitover35_article_generator import FitOver35ArticleGenerator

          num_articles = int('${{ github.event.inputs.num_articles }}' or '3')
          generator = FitOver35ArticleGenerator()
          articles = generator.run_weekly_generation(num_articles)

          print(f'\\n=== Summary ===')
          print(f'Articles generated: {len(articles)}')
          for article in articles:
              print(f'  - {article.title}')
          "

      - name: Submit sitemap to Google
        if: success()
        run: |
          # Ping Google to recrawl sitemap
          curl -s "https://www.google.com/ping?sitemap=https://fitover35.com/sitemap.xml" || true
          echo "Sitemap submitted to Google"

  notify-on-failure:
    needs: generate-articles
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Send failure notification
        run: |
          echo "Blog automation failed - check workflow logs"
          # Add email notification here if ALERT_EMAIL is configured
