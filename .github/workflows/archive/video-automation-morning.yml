name: Video Automation - Morning (6 AM PST)

on:
  schedule:
    # 6 AM PST = 2 PM UTC (during PST) or 1 PM UTC (during PDT)
    - cron: '0 14 * * *'
  push:
    branches:
      - 'claude/**'
  workflow_dispatch:
    inputs:
      brand:
        description: 'Specific brand to generate for (optional)'
        required: false
        type: string
      dry_run:
        description: 'Generate but do not post'
        required: false
        type: boolean
        default: false

env:
  PYTHON_VERSION: '3.11'

jobs:
  generate-videos:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Check critical configuration
        env:
          CREATOMATE_API_KEY: ${{ secrets.CREATOMATE_API_KEY }}
          LATE_API_KEY: ${{ secrets.LATE_API_KEY }}
        run: |
          echo "=============================================="
          echo "CONFIGURATION CHECK"
          echo "=============================================="

          if [ -z "$CREATOMATE_API_KEY" ]; then
            echo "❌ ERROR: CREATOMATE_API_KEY is NOT SET"
            echo "   Videos cannot be rendered - only placeholder URLs will be used"
            echo ""
          else
            echo "✅ CREATOMATE_API_KEY is configured"
          fi

          # Late API is preferred for Pinterest video posting
          if [ -n "$LATE_API_KEY" ]; then
            echo "✅ LATE_API_KEY is configured (preferred for Pinterest)"
          else
            echo "⚠️ LATE_API_KEY not set, using Make.com webhook fallback"
          fi

          echo "=============================================="

          # Write to summary
          echo "## Configuration Status" >> $GITHUB_STEP_SUMMARY
          if [ -z "$CREATOMATE_API_KEY" ]; then
            echo "- CREATOMATE_API_KEY: NOT SET" >> $GITHUB_STEP_SUMMARY
          else
            echo "- CREATOMATE_API_KEY: Configured" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -n "$LATE_API_KEY" ]; then
            echo "- LATE_API_KEY: Configured (preferred for Pinterest)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- LATE_API_KEY: Not set" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Run health check
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          python -m monitoring.health_checker --json > health_check.json
          cat health_check.json
          # Fail if critical services are down
          python -c "import json; data=json.load(open('health_check.json')); exit(0 if data.get('healthy', True) else 1)"

      - name: Generate and post videos
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
          CREATOMATE_API_KEY: ${{ secrets.CREATOMATE_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          YOUTUBE_CLIENT_ID: ${{ secrets.YOUTUBE_CLIENT_ID }}
          YOUTUBE_CLIENT_SECRET: ${{ secrets.YOUTUBE_CLIENT_SECRET }}
          YOUTUBE_REFRESH_TOKEN: ${{ secrets.YOUTUBE_REFRESH_TOKEN }}
          LATE_API_KEY: ${{ secrets.LATE_API_KEY }}
          LATE_API_KEY_2: ${{ secrets.LATE_API_KEY_2 }}
          LATE_API_KEY_3: ${{ secrets.LATE_API_KEY_3 }}
          LATE_API_KEY_4: ${{ secrets.LATE_API_KEY_4 }}
        run: |
          echo "=== LATE API KEYS STATUS ==="
          [ -n "$LATE_API_KEY" ] && echo "LATE_API_KEY: ✅" || echo "LATE_API_KEY: ❌"
          [ -n "$LATE_API_KEY_2" ] && echo "LATE_API_KEY_2: ✅" || echo "LATE_API_KEY_2: ❌"
          [ -n "$LATE_API_KEY_3" ] && echo "LATE_API_KEY_3: ✅" || echo "LATE_API_KEY_3: ❌"
          [ -n "$LATE_API_KEY_4" ] && echo "LATE_API_KEY_4: ✅" || echo "LATE_API_KEY_4: ❌"
          echo ""
          echo "=== BRAND SLOT CONFIGURATION ==="
          python3 -c "from video_automation.cross_platform_poster import get_brands_for_slot; brands = get_brands_for_slot('morning'); print(f'Brands for morning slot: {brands}'); print(f'Total videos to generate: {len(brands)}')"
          echo ""
          ARGS="--slot morning"
          if [ "${{ github.event.inputs.brand }}" != "" ]; then
            ARGS="--brand ${{ github.event.inputs.brand }}"
          fi
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            ARGS="$ARGS --dry-run"
          fi
          echo "=== RUNNING VIDEO GENERATOR ==="
          echo "Args: $ARGS"

          # Run generation - capture exit code but don't fail on partial failures
          python -m video_automation.daily_video_generator $ARGS || exit_code=$?

          # Only fail if exit code is 2 (no videos generated at all)
          # Exit code 1 means videos generated but posting partially failed (acceptable)
          if [ "${exit_code:-0}" -eq 2 ]; then
            echo "::error::No videos were generated - check Gemini/Pexels API"
            exit 1
          fi

          echo "Video generation completed (some platform postings may have failed)"

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: morning-generation-logs
          path: |
            *.log
            health_check.json
          retention-days: 7

  # Email notifications disabled - self-healing handles failures
  # Weekly summary includes video generation stats
