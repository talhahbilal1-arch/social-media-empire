name: Debug Configuration

on:
  push:
    branches:
      - 'claude/**'
  workflow_dispatch:

jobs:
  check-config:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install python-dotenv requests

      - name: Check Configuration
        id: config-check
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
          CREATOMATE_API_KEY: ${{ secrets.CREATOMATE_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          YOUTUBE_CLIENT_ID: ${{ secrets.YOUTUBE_CLIENT_ID }}
          YOUTUBE_CLIENT_SECRET: ${{ secrets.YOUTUBE_CLIENT_SECRET }}
          YOUTUBE_REFRESH_TOKEN: ${{ secrets.YOUTUBE_REFRESH_TOKEN }}
          LATE_API_KEY: ${{ secrets.LATE_API_KEY }}
          MAKE_COM_PINTEREST_WEBHOOK: ${{ secrets.MAKE_COM_PINTEREST_WEBHOOK }}
        run: |
          python << 'EOF'
          import os

          print("=" * 60)
          print("CONFIGURATION STATUS CHECK")
          print("=" * 60)

          secrets = {
              "GEMINI_API_KEY": os.environ.get("GEMINI_API_KEY", ""),
              "PEXELS_API_KEY": os.environ.get("PEXELS_API_KEY", ""),
              "CREATOMATE_API_KEY": os.environ.get("CREATOMATE_API_KEY", ""),
              "SUPABASE_URL": os.environ.get("SUPABASE_URL", ""),
              "SUPABASE_KEY": os.environ.get("SUPABASE_KEY", ""),
              "YOUTUBE_CLIENT_ID": os.environ.get("YOUTUBE_CLIENT_ID", ""),
              "YOUTUBE_CLIENT_SECRET": os.environ.get("YOUTUBE_CLIENT_SECRET", ""),
              "YOUTUBE_REFRESH_TOKEN": os.environ.get("YOUTUBE_REFRESH_TOKEN", ""),
              "LATE_API_KEY": os.environ.get("LATE_API_KEY", ""),
              "MAKE_COM_PINTEREST_WEBHOOK": os.environ.get("MAKE_COM_PINTEREST_WEBHOOK", ""),
          }

          print("\nüìã Secret Configuration:")
          print("-" * 40)
          for name, value in secrets.items():
              if value:
                  # Show first 4 and last 4 chars only for security
                  masked = value[:4] + "..." + value[-4:] if len(value) > 12 else "****"
                  print(f"‚úÖ {name}: CONFIGURED ({masked})")
              else:
                  print(f"‚ùå {name}: NOT SET")

          print("\n" + "=" * 60)
          print("CRITICAL FOR PINTEREST POSTING:")
          print("=" * 60)

          if not secrets["CREATOMATE_API_KEY"]:
              print("‚ùå CREATOMATE_API_KEY is NOT SET!")
              print("   ‚Üí Videos cannot be rendered")
              print("   ‚Üí Placeholder URLs will be used")
              print("   ‚Üí Nothing will be posted to Pinterest")
          else:
              print("‚úÖ CREATOMATE_API_KEY is set")

          if secrets["LATE_API_KEY"]:
              print("‚úÖ LATE_API_KEY is set (preferred for Pinterest)")
          elif secrets["MAKE_COM_PINTEREST_WEBHOOK"]:
              print("‚ö†Ô∏è  LATE_API_KEY not set, using Make.com webhook fallback")
              webhook = secrets["MAKE_COM_PINTEREST_WEBHOOK"]
              if webhook.startswith("https://hook."):
                  print("   ‚Üí Webhook URL format looks correct")
              else:
                  print("   ‚ö†Ô∏è Webhook URL format may be incorrect")
          else:
              print("‚ùå No Pinterest posting configured!")
              print("   ‚Üí Set LATE_API_KEY (preferred) or MAKE_COM_PINTEREST_WEBHOOK")

          print("\n" + "=" * 60)
          EOF

      - name: Test Creatomate Connection
        env:
          CREATOMATE_API_KEY: ${{ secrets.CREATOMATE_API_KEY }}
        run: |
          python << 'EOF'
          import os
          import requests

          api_key = os.environ.get("CREATOMATE_API_KEY", "")

          print("\nüìπ CREATOMATE API TEST:")
          print("-" * 40)

          if not api_key:
              print("‚ùå Cannot test - CREATOMATE_API_KEY not set")
          else:
              try:
                  response = requests.get(
                      "https://api.creatomate.com/v1/templates",
                      headers={"Authorization": f"Bearer {api_key}"},
                      timeout=10
                  )
                  if response.status_code == 200:
                      templates = response.json()
                      print(f"‚úÖ Creatomate API connected successfully")
                      print(f"   ‚Üí Found {len(templates)} templates")

                      # Check for expected template
                      expected_id = "1be9bec1-93d3-40b4-811b-e9ba235112fb"
                      found = any(t.get("id") == expected_id for t in templates)
                      if found:
                          print(f"   ‚úÖ Expected template {expected_id[:8]}... found")
                      else:
                          print(f"   ‚ùå Expected template {expected_id[:8]}... NOT FOUND")
                          print(f"   ‚Üí Available templates: {[t.get('id')[:8] + '...' for t in templates[:5]]}")
                  else:
                      print(f"‚ùå Creatomate API error: {response.status_code}")
                      print(f"   ‚Üí Response: {response.text[:200]}")
              except Exception as e:
                  print(f"‚ùå Creatomate connection failed: {e}")
          EOF

      - name: Test Pinterest Webhook
        env:
          MAKE_COM_PINTEREST_WEBHOOK: ${{ secrets.MAKE_COM_PINTEREST_WEBHOOK }}
        run: |
          python << 'EOF'
          import os
          import requests

          webhook = os.environ.get("MAKE_COM_PINTEREST_WEBHOOK", "")

          print("\nüìå PINTEREST WEBHOOK TEST:")
          print("-" * 40)

          if not webhook:
              print("‚ùå Cannot test - MAKE_COM_PINTEREST_WEBHOOK not set")
          else:
              print(f"‚úÖ Webhook URL is set")
              print(f"   ‚Üí URL starts with: {webhook[:30]}...")

              # Don't actually call the webhook to avoid creating posts
              # Just verify the URL format
              if "hook.make.com" in webhook or "hook.eu1.make.com" in webhook or "hook.us1.make.com" in webhook:
                  print("   ‚úÖ URL format appears to be a valid Make.com webhook")
              else:
                  print("   ‚ö†Ô∏è URL may not be a Make.com webhook")
          EOF

      - name: Write Summary
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
          CREATOMATE_API_KEY: ${{ secrets.CREATOMATE_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          YOUTUBE_REFRESH_TOKEN: ${{ secrets.YOUTUBE_REFRESH_TOKEN }}
          MAKE_COM_PINTEREST_WEBHOOK: ${{ secrets.MAKE_COM_PINTEREST_WEBHOOK }}
        run: |
          echo "## üîß Configuration Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Secret | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY

          if [ -n "$GEMINI_API_KEY" ]; then echo "| GEMINI_API_KEY | ‚úÖ Set |" >> $GITHUB_STEP_SUMMARY; else echo "| GEMINI_API_KEY | ‚ùå **NOT SET** |" >> $GITHUB_STEP_SUMMARY; fi
          if [ -n "$PEXELS_API_KEY" ]; then echo "| PEXELS_API_KEY | ‚úÖ Set |" >> $GITHUB_STEP_SUMMARY; else echo "| PEXELS_API_KEY | ‚ùå **NOT SET** |" >> $GITHUB_STEP_SUMMARY; fi
          if [ -n "$CREATOMATE_API_KEY" ]; then echo "| CREATOMATE_API_KEY | ‚úÖ Set |" >> $GITHUB_STEP_SUMMARY; else echo "| CREATOMATE_API_KEY | ‚ùå **NOT SET** |" >> $GITHUB_STEP_SUMMARY; fi
          if [ -n "$SUPABASE_URL" ]; then echo "| SUPABASE_URL | ‚úÖ Set |" >> $GITHUB_STEP_SUMMARY; else echo "| SUPABASE_URL | ‚ùå **NOT SET** |" >> $GITHUB_STEP_SUMMARY; fi
          if [ -n "$SUPABASE_KEY" ]; then echo "| SUPABASE_KEY | ‚úÖ Set |" >> $GITHUB_STEP_SUMMARY; else echo "| SUPABASE_KEY | ‚ùå **NOT SET** |" >> $GITHUB_STEP_SUMMARY; fi
          if [ -n "$YOUTUBE_REFRESH_TOKEN" ]; then echo "| YOUTUBE_REFRESH_TOKEN | ‚úÖ Set |" >> $GITHUB_STEP_SUMMARY; else echo "| YOUTUBE_REFRESH_TOKEN | ‚ùå **NOT SET** |" >> $GITHUB_STEP_SUMMARY; fi
          if [ -n "$MAKE_COM_PINTEREST_WEBHOOK" ]; then echo "| MAKE_COM_PINTEREST_WEBHOOK | ‚úÖ Set |" >> $GITHUB_STEP_SUMMARY; else echo "| MAKE_COM_PINTEREST_WEBHOOK | ‚ùå **NOT SET** |" >> $GITHUB_STEP_SUMMARY; fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üéØ Pinterest Posting Requirements" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -z "$CREATOMATE_API_KEY" ]; then
            echo "‚ùå **CREATOMATE_API_KEY is NOT SET** - Videos cannot be rendered, only placeholder URLs will be used" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -z "$MAKE_COM_PINTEREST_WEBHOOK" ]; then
            echo "‚ùå **MAKE_COM_PINTEREST_WEBHOOK is NOT SET** - Pinterest posting is disabled" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -n "$CREATOMATE_API_KEY" ] && [ -n "$MAKE_COM_PINTEREST_WEBHOOK" ]; then
            echo "‚úÖ Both CREATOMATE_API_KEY and MAKE_COM_PINTEREST_WEBHOOK are configured" >> $GITHUB_STEP_SUMMARY
          fi
