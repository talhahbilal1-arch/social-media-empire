# Weekly Deals Email Automation
# Runs every Tuesday at 10 AM EST (15:00 UTC) to find deals and generate email

name: Weekly Deals Email

on:
  schedule:
    # Every Tuesday at 10 AM EST (15:00 UTC)
    - cron: '0 15 * * 2'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Use mock data instead of API calls'
        type: boolean
        default: false
      send_email:
        description: 'Actually send the email via ConvertKit'
        type: boolean
        default: false

env:
  RAINFOREST_API_KEY: ${{ secrets.RAINFOREST_API_KEY }}
  CONVERTKIT_API_KEY: ${{ secrets.CONVERTKIT_API_KEY }}
  CONVERTKIT_API_SECRET: ${{ secrets.CONVERTKIT_API_SECRET }}

jobs:
  generate-weekly-email:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests

      - name: Find weekly deals
        id: find-deals
        run: |
          cd automation/email

          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "Running in dry-run mode with mock data..."
            python3 weekly_deals_finder.py --dry-run --output weekly_deals.json
          else
            echo "Fetching real deals from Rainforest API..."
            python3 weekly_deals_finder.py --output weekly_deals.json
          fi

          # Count deals found
          DEAL_COUNT=$(python3 -c "import json; print(len(json.load(open('weekly_deals.json'))['deals']))")
          echo "deal_count=$DEAL_COUNT" >> $GITHUB_OUTPUT
          echo "Found $DEAL_COUNT deals"

      - name: Generate email HTML
        run: |
          cd automation/email
          python3 generate_weekly_email.py \
            --input weekly_deals.json \
            --output-html weekly_email.html \
            --output-text weekly_email.txt

          echo "Email generated successfully"
          echo "HTML size: $(wc -c < weekly_email.html) bytes"
          echo "Text size: $(wc -c < weekly_email.txt) bytes"

      - name: Upload email artifacts
        uses: actions/upload-artifact@v4
        with:
          name: weekly-email-${{ github.run_number }}
          path: |
            automation/email/weekly_deals.json
            automation/email/weekly_email.html
            automation/email/weekly_email.txt
          retention-days: 30

      - name: Send email via ConvertKit
        if: ${{ github.event.inputs.send_email == 'true' || github.event_name == 'schedule' }}
        run: |
          cd automation/email

          # Check if ConvertKit credentials are set
          if [ -z "$CONVERTKIT_API_SECRET" ]; then
            echo "âš ï¸ CONVERTKIT_API_SECRET not set - skipping email send"
            echo "Email HTML saved as artifact for manual sending"
            exit 0
          fi

          echo "Sending email via ConvertKit..."

          # Read email content
          SUBJECT="This Week's Best Deals ðŸŽ‰ - $(date +'%B %d, %Y')"
          HTML_CONTENT=$(cat weekly_email.html)
          TEXT_CONTENT=$(cat weekly_email.txt)

          # Create broadcast via ConvertKit API
          # Note: This creates a draft broadcast that needs to be reviewed
          RESPONSE=$(curl -s -X POST "https://api.convertkit.com/v3/broadcasts" \
            -H "Content-Type: application/json" \
            -d "{
              \"api_secret\": \"$CONVERTKIT_API_SECRET\",
              \"subject\": \"$SUBJECT\",
              \"content\": $(echo "$HTML_CONTENT" | python3 -c 'import json,sys; print(json.dumps(sys.stdin.read()))'),
              \"description\": \"Weekly deals email - auto-generated\"
            }")

          echo "ConvertKit Response: $RESPONSE"

          # Check if broadcast was created
          BROADCAST_ID=$(echo "$RESPONSE" | python3 -c "import json,sys; d=json.load(sys.stdin); print(d.get('broadcast',{}).get('id',''))" 2>/dev/null || echo "")

          if [ -n "$BROADCAST_ID" ]; then
            echo "âœ… Broadcast created with ID: $BROADCAST_ID"
            echo "ðŸ“§ Review and send at: https://app.convertkit.com/broadcasts/$BROADCAST_ID"
          else
            echo "âš ï¸ Could not create broadcast - email saved as artifact"
          fi

      - name: Summary
        run: |
          echo "## Weekly Deals Email Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Deals Found:** ${{ steps.find-deals.outputs.deal_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run Type:** ${{ github.event_name == 'schedule' && 'Scheduled' || 'Manual' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Dry Run:** ${{ github.event.inputs.dry_run || 'false' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the email artifact to review" >> $GITHUB_STEP_SUMMARY
          echo "2. If using ConvertKit, review the broadcast draft" >> $GITHUB_STEP_SUMMARY
          echo "3. Send to subscribers!" >> $GITHUB_STEP_SUMMARY
