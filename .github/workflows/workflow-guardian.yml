name: Workflow Guardian

on:
  schedule:
    # Run every 6 hours (reduced from 30min ‚Äî was overkill for $0 revenue system)
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - analyze_and_heal
          - health_check
          - dry_run
      hours:
        description: 'Hours to look back'
        required: false
        type: number
        default: 6

permissions:
  contents: read
  actions: write
  issues: write

env:
  PYTHON_VERSION: '3.11'

jobs:
  guardian:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Workflow Guardian
        id: guardian
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          ALERT_EMAIL: ${{ secrets.ALERT_EMAIL }}
        run: |
          ACTION="${{ github.event.inputs.action || 'analyze_and_heal' }}"
          HOURS="${{ github.event.inputs.hours || '6' }}"

          echo "Running Workflow Guardian..."
          echo "Action: $ACTION"
          echo "Hours: $HOURS"
          echo ""

          if [ "$ACTION" == "health_check" ]; then
            python -m monitoring.workflow_guardian --health --json > guardian_result.json
          elif [ "$ACTION" == "dry_run" ]; then
            python -m monitoring.workflow_guardian --analyze --hours $HOURS --dry-run --json > guardian_result.json
          else
            python -m monitoring.workflow_guardian --analyze --hours $HOURS --json > guardian_result.json
          fi

          cat guardian_result.json

          # Extract key metrics for summary
          if [ "$ACTION" == "health_check" ]; then
            SCORE=$(python -c "import json; print(json.load(open('guardian_result.json'))['health_score'])")
            STATUS=$(python -c "import json; print(json.load(open('guardian_result.json'))['status'])")
            echo "health_score=$SCORE" >> $GITHUB_OUTPUT
            echo "status=$STATUS" >> $GITHUB_OUTPUT
          else
            ANALYZED=$(python -c "import json; print(json.load(open('guardian_result.json'))['analyzed'])")
            RETRIED=$(python -c "import json; print(json.load(open('guardian_result.json'))['retried'])")
            ALERTED=$(python -c "import json; print(json.load(open('guardian_result.json'))['alerted'])")
            echo "analyzed=$ANALYZED" >> $GITHUB_OUTPUT
            echo "retried=$RETRIED" >> $GITHUB_OUTPUT
            echo "alerted=$ALERTED" >> $GITHUB_OUTPUT
          fi

      - name: Upload Guardian Report
        uses: actions/upload-artifact@v4
        with:
          name: guardian-report-${{ github.run_number }}
          path: guardian_result.json
          retention-days: 30

      - name: Create Summary
        run: |
          echo "## Workflow Guardian Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run Time:** $(date -u '+%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          ACTION="${{ github.event.inputs.action || 'analyze_and_heal' }}"

          if [ "$ACTION" == "health_check" ]; then
            echo "### Health Status" >> $GITHUB_STEP_SUMMARY
            echo "- **Health Score:** ${{ steps.guardian.outputs.health_score }}%" >> $GITHUB_STEP_SUMMARY
            echo "- **Status:** ${{ steps.guardian.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "### Analysis Results" >> $GITHUB_STEP_SUMMARY
            echo "- **Failures Analyzed:** ${{ steps.guardian.outputs.analyzed }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Workflows Retried:** ${{ steps.guardian.outputs.retried }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Alerts Created:** ${{ steps.guardian.outputs.alerted }}" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Full Report" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          cat guardian_result.json >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # Quick health check that runs more frequently
  quick-check:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    timeout-minutes: 5

    steps:
      - name: Quick API Health Check
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          echo "Quick health check..."

          # Check Supabase
          if curl -sf -o /dev/null -w "%{http_code}" \
            -H "apikey: $SUPABASE_KEY" \
            "$SUPABASE_URL/rest/v1/"; then
            echo "‚úÖ Supabase: OK"
          else
            echo "‚ùå Supabase: FAILED"
          fi

          # Check Pexels
          if curl -sf -o /dev/null -w "%{http_code}" \
            -H "Authorization: $PEXELS_API_KEY" \
            "https://api.pexels.com/v1/search?query=test&per_page=1"; then
            echo "‚úÖ Pexels: OK"
          else
            echo "‚ùå Pexels: FAILED"
          fi

          echo "Quick check complete"

  # Alert if guardian itself fails
  alert-on-guardian-failure:
    runs-on: ubuntu-latest
    needs: guardian
    if: failure()

    steps:
      - name: Alert on Guardian Failure
        env:
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          ALERT_EMAIL: ${{ secrets.ALERT_EMAIL }}
        run: |
          if [ -z "$RESEND_API_KEY" ] || [ -z "$ALERT_EMAIL" ]; then
            echo "Email alerting not configured"
            exit 0
          fi

          pip install resend
          python -c "
          import resend
          import os

          resend.api_key = os.environ['RESEND_API_KEY']

          try:
              resend.Emails.send({
                  'from': 'alerts@socialmediaempire.com',
                  'to': [os.environ['ALERT_EMAIL']],
                  'subject': 'üö® CRITICAL: Workflow Guardian Failed',
                  'html': '''
                  <h1>Workflow Guardian Failure</h1>
                  <p>The self-healing system itself has failed!</p>
                  <p>This requires immediate attention.</p>
                  <p><a href=\"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\">View run</a></p>
                  '''
              })
          except Exception as e:
              print(f'Failed to send alert: {e}')
          "
