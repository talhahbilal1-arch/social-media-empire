name: Emergency Alert (Dead Man's Switch)

on:
  schedule:
    # Midnight PST daily (8 AM UTC)
    - cron: '0 8 * * *'
  workflow_dispatch:

jobs:
  check-content-engine:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Check if content-engine ran in last 24h
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check last successful content-engine run
          LAST_RUN=$(gh api "repos/${{ github.repository }}/actions/workflows/content-engine.yml/runs?status=success&per_page=1" --jq '.workflow_runs[0].created_at // empty' 2>/dev/null || echo "")

          if [ -z "$LAST_RUN" ]; then
            echo "WARNING: No successful content-engine runs found"
            echo "::warning::Content engine has no recent successful runs"
          else
            # Check if last run was within 26 hours
            LAST_EPOCH=$(date -d "$LAST_RUN" +%s 2>/dev/null || date -jf "%Y-%m-%dT%H:%M:%SZ" "$LAST_RUN" +%s 2>/dev/null || echo "0")
            NOW_EPOCH=$(date +%s)
            DIFF=$(( NOW_EPOCH - LAST_EPOCH ))
            HOURS=$(( DIFF / 3600 ))

            echo "Last successful run: $LAST_RUN ($HOURS hours ago)"

            if [ "$HOURS" -gt 26 ]; then
              echo "::warning::Content engine hasn't run in $HOURS hours"
            else
              echo "OK: Content engine ran $HOURS hours ago"
            fi
          fi

          # No email notifications — issues logged to GitHub only
          # Weekly summary email covers all failures

      - name: Create summary
        if: always()
        run: |
          echo "## Dead Man's Switch Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Checked if content-engine ran in last 24 hours." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_No email notification — check weekly summary for health trends._" >> $GITHUB_STEP_SUMMARY
