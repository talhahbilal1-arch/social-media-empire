name: Test Pinterest Post (Direct)

on:
  push:
    branches:
      - 'claude/**'
  workflow_dispatch:

jobs:
  test-pinterest:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Test Pinterest posting directly
        id: pinterest-test
        continue-on-error: true
        env:
          LATE_API_KEY: ${{ secrets.LATE_API_KEY }}
          MAKE_COM_PINTEREST_WEBHOOK: ${{ secrets.MAKE_COM_PINTEREST_WEBHOOK }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
          CREATOMATE_API_KEY: ${{ secrets.CREATOMATE_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          python << 'PYEOF'
          import os
          import sys
          import json
          import logging

          logging.basicConfig(level=logging.DEBUG)
          logger = logging.getLogger("pinterest_test")

          summary_file = os.environ.get("GITHUB_STEP_SUMMARY", "")
          summary_lines = []

          def write_summary(text):
              print(text)
              summary_lines.append(text)
              if summary_file:
                  try:
                      with open(summary_file, "a") as f:
                          f.write(text + "\n")
                  except Exception:
                      pass

          def save_and_exit(code):
              with open("pinterest-test-results.txt", "w") as f:
                  f.write("\n".join(summary_lines))
              sys.exit(code)

          write_summary("# Pinterest Direct Test\n")

          # Step 1: Check ALL secrets configuration
          write_summary("## Configuration Check\n")

          late_api_key = os.environ.get("LATE_API_KEY", "")
          make_webhook = os.environ.get("MAKE_COM_PINTEREST_WEBHOOK", "")
          creatomate_key = os.environ.get("CREATOMATE_API_KEY", "")
          gemini_key = os.environ.get("GEMINI_API_KEY", "")
          pexels_key = os.environ.get("PEXELS_API_KEY", "")
          supabase_url = os.environ.get("SUPABASE_URL", "")
          supabase_key = os.environ.get("SUPABASE_KEY", "")

          secrets_status = {
              "LATE_API_KEY": late_api_key,
              "MAKE_COM_PINTEREST_WEBHOOK": make_webhook,
              "CREATOMATE_API_KEY": creatomate_key,
              "GEMINI_API_KEY": gemini_key,
              "PEXELS_API_KEY": pexels_key,
              "SUPABASE_URL": supabase_url,
              "SUPABASE_KEY": supabase_key,
          }

          write_summary("| Secret | Status |")
          write_summary("|--------|--------|")
          for name, value in secrets_status.items():
              if value:
                  masked = value[:4] + "..." + value[-4:] if len(value) > 12 else "****"
                  write_summary(f"| {name} | SET ({masked}) |")
              else:
                  write_summary(f"| {name} | **NOT SET** |")

          write_summary("")

          if not late_api_key and not make_webhook:
              write_summary("## FAILURE: No Pinterest credentials configured\n")
              write_summary("Neither LATE_API_KEY nor MAKE_COM_PINTEREST_WEBHOOK is set.")
              write_summary("")
              write_summary("**To fix:** Add at least one of these as a GitHub repository secret:")
              write_summary("1. Go to https://github.com/talhahbilal1-arch/social-media-empire/settings/secrets/actions")
              write_summary("2. Add LATE_API_KEY (get from https://getlate.dev)")
              write_summary("3. OR add MAKE_COM_PINTEREST_WEBHOOK (from your Make.com scenario)")
              save_and_exit(1)

          # Step 2: Use a real Pexels video as test content
          write_summary("## Fetching Test Video\n")

          test_video_url = None

          if pexels_key:
              import requests
              try:
                  resp = requests.get(
                      "https://api.pexels.com/videos/search",
                      headers={"Authorization": pexels_key},
                      params={"query": "wellness tips", "per_page": 1, "orientation": "portrait"},
                      timeout=10
                  )
                  if resp.status_code == 200:
                      videos = resp.json().get("videos", [])
                      if videos:
                          files = videos[0].get("video_files", [])
                          for f in files:
                              if f.get("quality") == "hd":
                                  test_video_url = f.get("link")
                                  break
                          if not test_video_url and files:
                              test_video_url = files[0].get("link")
                      write_summary(f"- Pexels video found: {test_video_url[:80] if test_video_url else 'None'}...")
                  else:
                      write_summary(f"- Pexels API returned status {resp.status_code}")
              except Exception as e:
                  write_summary(f"- Pexels API error: {e}")

          if not test_video_url:
              # Fallback to a known public domain test video
              test_video_url = "https://sample-videos.com/video321/mp4/720/big_buck_bunny_720p_1mb.mp4"
              write_summary(f"- Using fallback test video: {test_video_url}")

          # Step 3: Try posting to Pinterest
          write_summary("\n## Pinterest Posting Test\n")

          test_title = "Wellness Tips for Your Best Day"
          test_description = "Quick wellness tips to boost your energy and feel amazing! #wellness #health #selfcare #tips #lifestyle"
          test_board = "daily-deal-darling-tips"

          write_summary(f"- Title: {test_title}")
          write_summary(f"- Board: {test_board}")
          write_summary(f"- Video URL: {test_video_url[:80]}...")

          # Method 1: Late API
          if late_api_key:
              write_summary("\n### Attempting Late API...\n")
              try:
                  from src.clients.late_api import LateAPIClient
                  client = LateAPIClient(api_key=late_api_key)

                  result = client.create_pinterest_video_pin(
                      video_url=test_video_url,
                      title=test_title,
                      description=test_description,
                      link="https://dailydealdarling.com",
                      board_id=test_board,
                      publish_now=True
                  )

                  if result.success:
                      write_summary(f"**SUCCESS via Late API!**")
                      write_summary(f"- Post ID: {result.post_id}")
                      write_summary(f"- URL: {result.platform_post_url or 'pending'}")
                      write_summary(f"- Raw: {json.dumps(result.raw_response, indent=2)[:500]}")
                      save_and_exit(0)
                  else:
                      write_summary(f"**Late API failed**: {result.error}")
                      write_summary(f"- Raw: {json.dumps(result.raw_response, indent=2)[:500]}")
              except Exception as e:
                  write_summary(f"**Late API exception**: {e}")
                  import traceback
                  write_summary(f"```\n{traceback.format_exc()}\n```")

          # Method 2: Make.com webhook
          if make_webhook:
              write_summary("\n### Attempting Make.com Webhook...\n")
              try:
                  import requests
                  payload = {
                      "type": "video_pin",
                      "board_id": test_board,
                      "title": test_title,
                      "description": test_description,
                      "video_url": test_video_url,
                      "media_url": test_video_url,
                      "link": "https://dailydealdarling.com",
                  }

                  write_summary(f"- Sending to: {make_webhook[:50]}...")
                  resp = requests.post(make_webhook, json=payload, timeout=30)
                  write_summary(f"- Response status: {resp.status_code}")
                  write_summary(f"- Response body: {resp.text[:500]}")

                  if resp.status_code == 200:
                      write_summary(f"\n**SUCCESS via Make.com webhook!**")
                      save_and_exit(0)
                  else:
                      write_summary(f"\n**Make.com webhook failed with status {resp.status_code}**")
              except Exception as e:
                  write_summary(f"**Make.com webhook exception**: {e}")
                  import traceback
                  write_summary(f"```\n{traceback.format_exc()}\n```")

          write_summary("\n## FINAL RESULT: FAILED\n")
          write_summary("Neither Late API nor Make.com webhook succeeded in posting to Pinterest.")

          save_and_exit(1)
          PYEOF

      - name: Save test results
        if: always()
        run: |
          echo "=== Pinterest Test Results ==="
          if [ -f pinterest-test-results.txt ]; then
            cat pinterest-test-results.txt
          else
            echo "No results file found - test may have crashed before writing output"
          fi
          echo ""
          echo "Test step outcome: ${{ steps.pinterest-test.outcome }}"

      - name: Diagnose error type
        id: diagnose
        if: always()
        run: |
          if [ ! -f pinterest-test-results.txt ]; then
            echo "error_type=no_results_file" >> $GITHUB_OUTPUT
          elif grep -q "SUCCESS" pinterest-test-results.txt; then
            echo "error_type=success" >> $GITHUB_OUTPUT
          elif grep -q "No module named" pinterest-test-results.txt; then
            echo "error_type=import_error" >> $GITHUB_OUTPUT
          elif grep -q "No Pinterest account" pinterest-test-results.txt; then
            echo "error_type=no_pinterest_account" >> $GITHUB_OUTPUT
          elif grep -q "NOT SET" pinterest-test-results.txt && grep -q "LATE_API_KEY" pinterest-test-results.txt; then
            echo "error_type=no_credentials" >> $GITHUB_OUTPUT
          elif grep -q "HTTPStatusError\|status_code\|401\|403\|404" pinterest-test-results.txt; then
            echo "error_type=api_http_error" >> $GITHUB_OUTPUT
          elif grep -q "ConnectionError\|TimeoutException\|ConnectError" pinterest-test-results.txt; then
            echo "error_type=connection_error" >> $GITHUB_OUTPUT
          else
            echo "error_type=unknown_error" >> $GITHUB_OUTPUT
          fi

      - name: DIAGNOSIS-SUCCESS-pin-posted
        if: always() && steps.diagnose.outputs.error_type == 'success'
        run: echo "Pinterest pin was posted successfully!"

      - name: DIAGNOSIS-import-error-missing-module
        if: always() && steps.diagnose.outputs.error_type == 'import_error'
        run: echo "Import error - a Python module is missing"

      - name: DIAGNOSIS-no-pinterest-account-in-late-api
        if: always() && steps.diagnose.outputs.error_type == 'no_pinterest_account'
        run: echo "Late API has no Pinterest account connected"

      - name: DIAGNOSIS-no-credentials-configured
        if: always() && steps.diagnose.outputs.error_type == 'no_credentials'
        run: echo "Neither LATE_API_KEY nor MAKE_COM_PINTEREST_WEBHOOK is set"

      - name: DIAGNOSIS-api-http-error
        if: always() && steps.diagnose.outputs.error_type == 'api_http_error'
        run: echo "HTTP error from API call"

      - name: DIAGNOSIS-connection-error
        if: always() && steps.diagnose.outputs.error_type == 'connection_error'
        run: echo "Network connection error"

      - name: DIAGNOSIS-unknown-error
        if: always() && steps.diagnose.outputs.error_type == 'unknown_error'
        run: |
          echo "Unknown error type. Results file content:"
          cat pinterest-test-results.txt 2>/dev/null || echo "File not found"

      - name: DIAGNOSIS-no-results-file
        if: always() && steps.diagnose.outputs.error_type == 'no_results_file'
        run: echo "No results file - script crashed before writing output"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pinterest-test-results
          path: pinterest-test-results.txt
          if-no-files-found: ignore
          retention-days: 7

      - name: Fail if test failed
        if: steps.pinterest-test.outcome == 'failure'
        run: |
          echo "Pinterest posting test FAILED"
          exit 1
