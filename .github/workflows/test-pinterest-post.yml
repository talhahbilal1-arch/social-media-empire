name: Test Pinterest Post (Direct)

on:
  push:
    branches:
      - 'claude/**'
  workflow_dispatch:

jobs:
  test-pinterest:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Test Pinterest posting directly
        id: pinterest-test
        continue-on-error: true
        env:
          LATE_API_KEY: ${{ secrets.LATE_API_KEY }}
          MAKE_COM_PINTEREST_WEBHOOK: ${{ secrets.MAKE_COM_PINTEREST_WEBHOOK }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
          CREATOMATE_API_KEY: ${{ secrets.CREATOMATE_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          python << 'PYEOF'
          import os
          import sys
          import json
          import logging

          logging.basicConfig(level=logging.DEBUG)
          logger = logging.getLogger("pinterest_test")

          summary_file = os.environ.get("GITHUB_STEP_SUMMARY", "")
          output_file = os.environ.get("GITHUB_OUTPUT", "")
          summary_lines = []

          def write_summary(text):
              print(text)
              summary_lines.append(text)
              if summary_file:
                  try:
                      with open(summary_file, "a") as f:
                          f.write(text + "\n")
                  except Exception:
                      pass

          def write_output(key, value):
              """Write a key=value pair to GITHUB_OUTPUT for use in subsequent steps."""
              if output_file:
                  try:
                      with open(output_file, "a") as f:
                          f.write(f"{key}={value}\n")
                  except Exception:
                      pass

          def save_and_exit(code):
              with open("pinterest-test-results.txt", "w") as f:
                  f.write("\n".join(summary_lines))
              sys.exit(code)

          write_summary("# Pinterest Direct Test\n")

          # Step 1: Check ALL secrets configuration
          write_summary("## Configuration Check\n")

          late_api_key = os.environ.get("LATE_API_KEY", "")
          make_webhook = os.environ.get("MAKE_COM_PINTEREST_WEBHOOK", "")
          creatomate_key = os.environ.get("CREATOMATE_API_KEY", "")
          gemini_key = os.environ.get("GEMINI_API_KEY", "")
          pexels_key = os.environ.get("PEXELS_API_KEY", "")
          supabase_url = os.environ.get("SUPABASE_URL", "")
          supabase_key = os.environ.get("SUPABASE_KEY", "")

          secrets_status = {
              "LATE_API_KEY": late_api_key,
              "MAKE_COM_PINTEREST_WEBHOOK": make_webhook,
              "CREATOMATE_API_KEY": creatomate_key,
              "GEMINI_API_KEY": gemini_key,
              "PEXELS_API_KEY": pexels_key,
              "SUPABASE_URL": supabase_url,
              "SUPABASE_KEY": supabase_key,
          }

          write_summary("| Secret | Status |")
          write_summary("|--------|--------|")
          for name, value in secrets_status.items():
              if value:
                  masked = value[:4] + "..." + value[-4:] if len(value) > 12 else "****"
                  write_summary(f"| {name} | SET ({masked}) |")
              else:
                  write_summary(f"| {name} | **NOT SET** |")

          write_summary("")

          if not late_api_key and not make_webhook:
              write_summary("## FAILURE: No Pinterest credentials configured\n")
              write_summary("Neither LATE_API_KEY nor MAKE_COM_PINTEREST_WEBHOOK is set.")
              write_summary("")
              write_summary("**To fix:** Add at least one of these as a GitHub repository secret:")
              write_summary("1. Go to https://github.com/talhahbilal1-arch/social-media-empire/settings/secrets/actions")
              write_summary("2. Add LATE_API_KEY (get from https://getlate.dev)")
              write_summary("3. OR add MAKE_COM_PINTEREST_WEBHOOK (from your Make.com scenario)")
              save_and_exit(1)

          # Step 2: Use a real Pexels video as test content
          write_summary("## Fetching Test Video\n")

          test_video_url = None

          if pexels_key:
              import requests
              try:
                  resp = requests.get(
                      "https://api.pexels.com/videos/search",
                      headers={"Authorization": pexels_key},
                      params={"query": "wellness tips", "per_page": 1, "orientation": "portrait"},
                      timeout=10
                  )
                  if resp.status_code == 200:
                      videos = resp.json().get("videos", [])
                      if videos:
                          files = videos[0].get("video_files", [])
                          for f in files:
                              if f.get("quality") == "hd":
                                  test_video_url = f.get("link")
                                  break
                          if not test_video_url and files:
                              test_video_url = files[0].get("link")
                      write_summary(f"- Pexels video found: {test_video_url[:80] if test_video_url else 'None'}...")
                  else:
                      write_summary(f"- Pexels API returned status {resp.status_code}")
              except Exception as e:
                  write_summary(f"- Pexels API error: {e}")

          if not test_video_url:
              # Fallback to a known public domain test video
              test_video_url = "https://sample-videos.com/video321/mp4/720/big_buck_bunny_720p_1mb.mp4"
              write_summary(f"- Using fallback test video: {test_video_url}")

          # Step 3: List accounts and boards via Late API (diagnostic)
          write_summary("\n## Late API Account Discovery\n")

          test_title = "Wellness Tips for Your Best Day"
          test_description = "Quick wellness tips to boost your energy and feel amazing! #wellness #health #selfcare #tips #lifestyle"

          if late_api_key:
              try:
                  import httpx

                  late_headers = {"Authorization": f"Bearer {late_api_key}"}
                  late_base = "https://getlate.dev/api/v1"

                  # List all accounts
                  write_summary("### Accounts\n")
                  acct_resp = httpx.get(f"{late_base}/accounts", headers=late_headers, timeout=30)
                  write_summary(f"- GET /accounts status: {acct_resp.status_code}")
                  acct_data = acct_resp.json()
                  write_summary(f"- Response: {json.dumps(acct_data, indent=2)[:1500]}")

                  # Find Pinterest account
                  pinterest_account_id = None
                  accounts = acct_data if isinstance(acct_data, list) else acct_data.get('accounts', acct_data.get('data', []))
                  for acct in accounts:
                      write_summary(f"- Account: platform={acct.get('platform')}, id={acct.get('_id', acct.get('id'))}, username={acct.get('username')}")
                      if acct.get('platform') == 'pinterest':
                          pinterest_account_id = acct.get('_id', acct.get('id'))

                  if pinterest_account_id:
                      write_summary(f"\n**Pinterest Account ID: {pinterest_account_id}**\n")
                      write_output("pinterest_account_found", "true")
                      write_output("pinterest_account_id", pinterest_account_id)

                      # List boards
                      write_summary("### Boards\n")
                      try:
                          boards_resp = httpx.get(f"{late_base}/accounts/{pinterest_account_id}/boards", headers=late_headers, timeout=30)
                          write_summary(f"- GET /accounts/{pinterest_account_id}/boards status: {boards_resp.status_code}")
                          boards_data = boards_resp.json()
                          boards_json = json.dumps(boards_data)
                          write_summary(f"- Response: {json.dumps(boards_data, indent=2)[:2000]}")
                          write_output("boards_status", str(boards_resp.status_code))
                          write_output("boards_response", boards_json[:500])
                      except Exception as e:
                          write_summary(f"- Boards listing error: {e}")
                          write_output("boards_error", str(e)[:200])
                  else:
                      write_summary("\n**No Pinterest account found in Late API**\n")
                      write_output("pinterest_account_found", "false")
              except Exception as e:
                  write_summary(f"Account discovery error: {e}")
                  import traceback
                  write_summary(f"```\n{traceback.format_exc()}\n```")

          # Step 4: Try posting to Pinterest
          write_summary("\n## Pinterest Posting Test\n")

          write_summary(f"- Title: {test_title}")
          write_summary(f"- Video URL: {test_video_url[:80]}...")

          # Method 1: Late API (try WITHOUT board_id first - let Late use default)
          if late_api_key:
              write_summary("\n### Attempting Late API (no board_id)...\n")
              try:
                  import httpx

                  late_headers = {"Authorization": f"Bearer {late_api_key}", "Content-Type": "application/json"}
                  late_base = "https://getlate.dev/api/v1"

                  # Find Pinterest account ID
                  acct_resp = httpx.get(f"{late_base}/accounts", headers=late_headers, timeout=30)
                  accounts = acct_resp.json()
                  if isinstance(accounts, list):
                      acct_list = accounts
                  else:
                      acct_list = accounts.get('accounts', accounts.get('data', []))

                  pinterest_id = None
                  for acct in acct_list:
                      if acct.get('platform') == 'pinterest':
                          pinterest_id = acct.get('_id', acct.get('id'))
                          break

                  if not pinterest_id:
                      write_summary("**No Pinterest account in Late API - cannot post**")
                      save_and_exit(1)

                  # Build payload using Late API docs format:
                  # - mediaItems (not mediaUrls) with type and url
                  # - platformSpecificData inside platform object (not top-level platformSettings)
                  payload = {
                      "content": f"{test_title}\n\n{test_description}",
                      "platforms": [
                          {
                              "platform": "pinterest",
                              "accountId": pinterest_id,
                              "platformSpecificData": {
                                  "link": "https://dailydealdarling.com"
                              }
                          }
                      ],
                      "mediaItems": [{"type": "video", "url": test_video_url}],
                  }

                  write_summary(f"- Payload: {json.dumps(payload, indent=2)[:1000]}")

                  # Post
                  post_resp = httpx.post(f"{late_base}/posts", headers=late_headers, json=payload, timeout=120)
                  write_summary(f"- POST /posts status: {post_resp.status_code}")
                  post_data = post_resp.json()
                  post_json_compact = json.dumps(post_data, separators=(',', ':'))
                  write_summary(f"- Full response: {json.dumps(post_data, indent=2)[:2000]}")
                  write_output("post_http_status", str(post_resp.status_code))
                  write_output("post_response", post_json_compact[:500])

                  # Check result
                  post = post_data.get('post', post_data)
                  status = post.get('status', '')
                  write_summary(f"- Post status: {status}")
                  write_output("post_status", status)
                  # Capture error message
                  post_error = post.get('error') or post.get('message') or ''
                  if post_error:
                      write_output("post_error", str(post_error)[:300])
                  # Capture platform-specific errors
                  for p in post.get('platforms', []):
                      if p.get('platform') == 'pinterest':
                          p_status = p.get('status', '')
                          p_error = p.get('error') or p.get('message') or ''
                          write_output("pinterest_platform_status", p_status)
                          if p_error:
                              write_output("pinterest_platform_error", str(p_error)[:300])

                  if status in ['published', 'queued', 'processing', 'scheduled']:
                      write_summary(f"\n**SUCCESS via Late API!**")
                      write_summary(f"- Post ID: {post.get('_id', post.get('id'))}")
                      platforms = post.get('platforms', [])
                      for p in platforms:
                          if p.get('platform') == 'pinterest':
                              write_summary(f"- Pinterest URL: {p.get('platformPostUrl', 'pending')}")
                      save_and_exit(0)
                  else:
                      error_msg = post.get('error') or post.get('message') or f"Unexpected status: {status}"
                      write_summary(f"\n**Late API failed**: {error_msg}")
                      # Look for more details in the response
                      errors = post.get('errors', [])
                      if errors:
                          write_summary(f"- Errors array: {json.dumps(errors, indent=2)[:500]}")
                      platforms = post.get('platforms', [])
                      for p in platforms:
                          write_summary(f"- Platform result: {json.dumps(p, indent=2)[:500]}")

              except Exception as e:
                  write_summary(f"**Late API exception**: {e}")
                  import traceback
                  write_summary(f"```\n{traceback.format_exc()}\n```")

          # Method 2: Make.com webhook
          if make_webhook:
              write_summary("\n### Attempting Make.com Webhook...\n")
              try:
                  import requests
                  payload = {
                      "type": "video_pin",
                      "board_id": test_board,
                      "title": test_title,
                      "description": test_description,
                      "video_url": test_video_url,
                      "media_url": test_video_url,
                      "link": "https://dailydealdarling.com",
                  }

                  write_summary(f"- Sending to: {make_webhook[:50]}...")
                  resp = requests.post(make_webhook, json=payload, timeout=30)
                  write_summary(f"- Response status: {resp.status_code}")
                  write_summary(f"- Response body: {resp.text[:500]}")

                  if resp.status_code == 200:
                      write_summary(f"\n**SUCCESS via Make.com webhook!**")
                      save_and_exit(0)
                  else:
                      write_summary(f"\n**Make.com webhook failed with status {resp.status_code}**")
              except Exception as e:
                  write_summary(f"**Make.com webhook exception**: {e}")
                  import traceback
                  write_summary(f"```\n{traceback.format_exc()}\n```")

          write_summary("\n## FINAL RESULT: FAILED\n")
          write_summary("Neither Late API nor Make.com webhook succeeded in posting to Pinterest.")

          save_and_exit(1)
          PYEOF

      - name: Save test results
        if: always()
        run: |
          echo "=== Pinterest Test Results ==="
          if [ -f pinterest-test-results.txt ]; then
            cat pinterest-test-results.txt
          else
            echo "No results file found - test may have crashed before writing output"
          fi
          echo ""
          echo "Test step outcome: ${{ steps.pinterest-test.outcome }}"

      - name: Diagnose error type
        id: diagnose
        if: always()
        run: |
          if [ ! -f pinterest-test-results.txt ]; then
            echo "error_type=no_results_file" >> $GITHUB_OUTPUT
          elif grep -q "SUCCESS" pinterest-test-results.txt; then
            echo "error_type=success" >> $GITHUB_OUTPUT
          elif grep -q "No module named" pinterest-test-results.txt; then
            echo "error_type=import_error" >> $GITHUB_OUTPUT
          elif grep -q "No Pinterest account connected" pinterest-test-results.txt; then
            echo "error_type=no_pinterest_account" >> $GITHUB_OUTPUT
          elif grep -q "Late API failed" pinterest-test-results.txt; then
            echo "error_type=late_api_failed" >> $GITHUB_OUTPUT
          elif grep -q "Late API exception" pinterest-test-results.txt; then
            echo "error_type=late_api_exception" >> $GITHUB_OUTPUT
          elif grep -q "Make.com webhook failed" pinterest-test-results.txt; then
            echo "error_type=webhook_failed" >> $GITHUB_OUTPUT
          elif grep -q "FAILURE: No Pinterest credentials configured" pinterest-test-results.txt; then
            echo "error_type=no_credentials" >> $GITHUB_OUTPUT
          elif grep -q "HTTPStatusError\|401\|403\|404" pinterest-test-results.txt; then
            echo "error_type=api_http_error" >> $GITHUB_OUTPUT
          elif grep -q "ConnectionError\|TimeoutException\|ConnectError" pinterest-test-results.txt; then
            echo "error_type=connection_error" >> $GITHUB_OUTPUT
          elif grep -q "Neither Late API nor Make.com" pinterest-test-results.txt; then
            echo "error_type=both_methods_failed" >> $GITHUB_OUTPUT
          else
            echo "error_type=unknown_error" >> $GITHUB_OUTPUT
          fi

          # Extract the actual error message for the Late API exception case
          if grep -q "Late API exception" pinterest-test-results.txt 2>/dev/null; then
            ERROR_LINE=$(grep "Late API exception" pinterest-test-results.txt | head -1)
            echo "late_error=${ERROR_LINE}" >> $GITHUB_OUTPUT
          fi
          # Also extract any traceback info
          if grep -q "Error\|error\|Traceback\|Exception" pinterest-test-results.txt 2>/dev/null; then
            TRACEBACK=$(grep -A2 "Late API exception\|Traceback\|Error" pinterest-test-results.txt | head -10 | tr '\n' ' | ')
            echo "traceback=${TRACEBACK}" >> $GITHUB_OUTPUT
          fi
          echo "---LAST-LINES---"
          tail -5 pinterest-test-results.txt 2>/dev/null || echo "no file"

      - name: DIAGNOSIS-SUCCESS-pin-posted
        if: always() && steps.diagnose.outputs.error_type == 'success'
        run: echo "Pinterest pin was posted successfully!"

      - name: DIAGNOSIS-import-error-missing-module
        if: always() && steps.diagnose.outputs.error_type == 'import_error'
        run: echo "Import error - a Python module is missing"

      - name: DIAGNOSIS-no-pinterest-account-in-late-api
        if: always() && steps.diagnose.outputs.error_type == 'no_pinterest_account'
        run: echo "Late API has no Pinterest account connected"

      - name: DIAGNOSIS-no-credentials-configured
        if: always() && steps.diagnose.outputs.error_type == 'no_credentials'
        run: echo "Neither LATE_API_KEY nor MAKE_COM_PINTEREST_WEBHOOK is set"

      - name: DIAGNOSIS-both-methods-failed
        if: always() && steps.diagnose.outputs.error_type == 'both_methods_failed'
        run: echo "Both Late API and Make.com webhook attempted but failed"

      - name: DIAGNOSIS-late-api-returned-failure
        if: always() && steps.diagnose.outputs.error_type == 'late_api_failed'
        run: |
          echo "Late API call succeeded but returned a failure response"
          echo "--- Full results file (line by line as annotations) ---"
          LINE_NUM=0
          while IFS= read -r line; do
            LINE_NUM=$((LINE_NUM + 1))
            # Write each non-empty line as a notice annotation
            if [ -n "$line" ]; then
              echo "::notice::RESULT_LINE_${LINE_NUM}: ${line}"
            fi
          done < pinterest-test-results.txt 2>/dev/null || echo "No results file"

      - name: DIAGNOSIS-late-api-threw-exception
        if: always() && steps.diagnose.outputs.error_type == 'late_api_exception'
        run: |
          echo "Late API call threw an exception"
          echo "Error: ${{ steps.diagnose.outputs.late_error }}"
          echo "Traceback: ${{ steps.diagnose.outputs.traceback }}"

      - name: Extract exception details
        id: extract-error
        if: always() && steps.diagnose.outputs.error_type == 'late_api_exception'
        run: |
          # Parse the exception type from the results
          if grep -q "Client error '4" pinterest-test-results.txt 2>/dev/null; then
            echo "detail=http_4xx_error" >> $GITHUB_OUTPUT
          elif grep -q "Client error '401" pinterest-test-results.txt 2>/dev/null; then
            echo "detail=unauthorized_401" >> $GITHUB_OUTPUT
          elif grep -q "Server error '5" pinterest-test-results.txt 2>/dev/null; then
            echo "detail=server_5xx_error" >> $GITHUB_OUTPUT
          elif grep -q "ConnectError\|ConnectionError" pinterest-test-results.txt 2>/dev/null; then
            echo "detail=connection_error" >> $GITHUB_OUTPUT
          elif grep -q "TimeoutException\|ReadTimeout" pinterest-test-results.txt 2>/dev/null; then
            echo "detail=timeout" >> $GITHUB_OUTPUT
          elif grep -q "JSONDecodeError" pinterest-test-results.txt 2>/dev/null; then
            echo "detail=json_decode_error" >> $GITHUB_OUTPUT
          elif grep -q "ValueError" pinterest-test-results.txt 2>/dev/null; then
            echo "detail=value_error" >> $GITHUB_OUTPUT
          elif grep -q "KeyError" pinterest-test-results.txt 2>/dev/null; then
            echo "detail=key_error" >> $GITHUB_OUTPUT
          elif grep -q "AttributeError" pinterest-test-results.txt 2>/dev/null; then
            echo "detail=attribute_error" >> $GITHUB_OUTPUT
          else
            echo "detail=other" >> $GITHUB_OUTPUT
          fi

      - name: ERRDETAIL-http-4xx-client-error
        if: always() && steps.extract-error.outputs.detail == 'http_4xx_error'
        run: echo "Late API returned HTTP 4xx client error"

      - name: ERRDETAIL-unauthorized-401
        if: always() && steps.extract-error.outputs.detail == 'unauthorized_401'
        run: echo "Late API returned 401 Unauthorized"

      - name: ERRDETAIL-server-5xx-error
        if: always() && steps.extract-error.outputs.detail == 'server_5xx_error'
        run: echo "Late API returned HTTP 5xx server error"

      - name: ERRDETAIL-connection-error
        if: always() && steps.extract-error.outputs.detail == 'connection_error'
        run: echo "Cannot connect to Late API server"

      - name: ERRDETAIL-timeout
        if: always() && steps.extract-error.outputs.detail == 'timeout'
        run: echo "Late API request timed out"

      - name: ERRDETAIL-json-decode-error
        if: always() && steps.extract-error.outputs.detail == 'json_decode_error'
        run: echo "Late API returned invalid JSON"

      - name: ERRDETAIL-value-error
        if: always() && steps.extract-error.outputs.detail == 'value_error'
        run: echo "ValueError in Late API client"

      - name: ERRDETAIL-key-error
        if: always() && steps.extract-error.outputs.detail == 'key_error'
        run: echo "KeyError - unexpected API response format"

      - name: ERRDETAIL-attribute-error
        if: always() && steps.extract-error.outputs.detail == 'attribute_error'
        run: echo "AttributeError in Late API client"

      - name: ERRDETAIL-other-exception
        if: always() && steps.extract-error.outputs.detail == 'other'
        run: |
          echo "Other exception type. Writing error as annotations..."
          # Extract the exception line and write it as a GitHub annotation
          EXCEPTION_LINE=$(grep "Late API exception" pinterest-test-results.txt 2>/dev/null | head -1)
          echo "::error::PINTEREST_ERROR: ${EXCEPTION_LINE}"
          # Also write any lines between "Late API exception" and "```" (the traceback)
          TRACEBACK=$(sed -n '/Late API exception/,/```/{p}' pinterest-test-results.txt 2>/dev/null | head -20)
          echo "::error::TRACEBACK: ${TRACEBACK}"
          # Also check for any other error indicators
          grep -i "error\|exception\|failed\|traceback" pinterest-test-results.txt 2>/dev/null | while read line; do
            echo "::error::DETAIL: ${line}"
          done

      - name: DIAGNOSIS-webhook-failed
        if: always() && steps.diagnose.outputs.error_type == 'webhook_failed'
        run: echo "Make.com webhook call failed"

      - name: DIAGNOSIS-api-http-error
        if: always() && steps.diagnose.outputs.error_type == 'api_http_error'
        run: echo "HTTP error from API call"

      - name: DIAGNOSIS-connection-error
        if: always() && steps.diagnose.outputs.error_type == 'connection_error'
        run: echo "Network connection error"

      - name: DIAGNOSIS-unknown-error
        if: always() && steps.diagnose.outputs.error_type == 'unknown_error'
        run: |
          echo "Unknown error type. Results file content:"
          cat pinterest-test-results.txt 2>/dev/null || echo "File not found"

      - name: DIAGNOSIS-no-results-file
        if: always() && steps.diagnose.outputs.error_type == 'no_results_file'
        run: echo "No results file - script crashed before writing output"

      # Surface key Late API response data via step names (visible in API)
      - name: LATE-ACCOUNT-FOUND
        if: always() && steps.pinterest-test.outputs.pinterest_account_found == 'true'
        run: echo "Pinterest account found in Late API with ID ${{ steps.pinterest-test.outputs.pinterest_account_id }}"

      - name: LATE-ACCOUNT-NOT-FOUND
        if: always() && steps.pinterest-test.outputs.pinterest_account_found == 'false'
        run: echo "No Pinterest account found in Late API"

      - name: LATE-POST-HTTP-STATUS
        if: always() && steps.pinterest-test.outputs.post_http_status != ''
        run: echo "HTTP status ${{ steps.pinterest-test.outputs.post_http_status }}"

      - name: LATE-POST-STATUS-VALUE
        if: always() && steps.pinterest-test.outputs.post_status != ''
        run: |
          echo "Post status: ${{ steps.pinterest-test.outputs.post_status }}"
          echo "::error::LATE_POST_STATUS: ${{ steps.pinterest-test.outputs.post_status }}"

      - name: LATE-POST-ERROR
        if: always() && steps.pinterest-test.outputs.post_error != ''
        run: |
          echo "Post error: ${{ steps.pinterest-test.outputs.post_error }}"
          echo "::error::LATE_POST_ERROR: ${{ steps.pinterest-test.outputs.post_error }}"

      - name: LATE-PINTEREST-PLATFORM-ERROR
        if: always() && steps.pinterest-test.outputs.pinterest_platform_error != ''
        run: |
          echo "Pinterest platform error: ${{ steps.pinterest-test.outputs.pinterest_platform_error }}"
          echo "::error::PINTEREST_PLATFORM_ERROR: ${{ steps.pinterest-test.outputs.pinterest_platform_error }}"

      - name: LATE-POST-RESPONSE-JSON
        if: always() && steps.pinterest-test.outputs.post_response != ''
        run: |
          echo "Post response JSON:"
          echo "${{ steps.pinterest-test.outputs.post_response }}"
          echo "::error::LATE_RESPONSE_JSON: ${{ steps.pinterest-test.outputs.post_response }}"

      - name: LATE-BOARDS-RESPONSE
        if: always() && steps.pinterest-test.outputs.boards_response != ''
        run: |
          echo "Boards response:"
          echo "${{ steps.pinterest-test.outputs.boards_response }}"
          echo "::error::BOARDS_RESPONSE: ${{ steps.pinterest-test.outputs.boards_response }}"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pinterest-test-results
          path: pinterest-test-results.txt
          if-no-files-found: ignore
          retention-days: 7

      - name: Fail if test failed
        if: steps.pinterest-test.outcome == 'failure'
        run: |
          echo "Pinterest posting test FAILED"
          exit 1
