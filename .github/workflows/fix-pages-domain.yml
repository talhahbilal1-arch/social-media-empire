name: Fix GitHub Pages Custom Domain

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/fix-pages-domain.yml'

permissions:
  contents: write
  pages: write
  id-token: write
  actions: write

jobs:
  configure-pages:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    environment:
      name: github-pages

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install GitHub CLI
        run: |
          type gh 2>/dev/null || (
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            sudo apt update && sudo apt install gh -y
          )

      - name: Check current Pages configuration
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=== Current Pages Config ==="
          gh api "repos/${{ github.repository }}/pages" 2>&1 || echo "Pages may not be configured yet"

      - name: Configure Pages - set source and custom domain
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=== Step 1: Ensure Pages is enabled with branch source ==="
          # Try updating first
          if ! gh api -X PUT "repos/${{ github.repository }}/pages" \
            -f source[branch]=main -f source[path]="/" 2>/dev/null; then
            echo "Update failed, trying to create Pages..."
            gh api -X POST "repos/${{ github.repository }}/pages" \
              -f source[branch]=main -f source[path]="/" 2>&1 || echo "Create also failed - Pages may need manual setup"
          fi

          echo ""
          echo "=== Step 2: Set custom domain ==="
          gh api -X PUT "repos/${{ github.repository }}/pages" \
            -f cname="dailydealdarling.com" \
            -f source[branch]=main \
            -f source[path]="/" 2>&1

          echo ""
          echo "=== Step 3: Request Pages build ==="
          gh api -X POST "repos/${{ github.repository }}/pages/builds" 2>&1 || echo "Build request sent (or already queued)"

          echo ""
          echo "=== Step 4: Wait for build then enable HTTPS ==="
          sleep 15
          gh api -X PUT "repos/${{ github.repository }}/pages" \
            -f cname="dailydealdarling.com" \
            -F https_enforced=true \
            -f source[branch]=main \
            -f source[path]="/" 2>&1 || echo "HTTPS enforcement may need DNS to propagate first"

      - name: Verify final configuration
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=== Final Pages Config ==="
          gh api "repos/${{ github.repository }}/pages" 2>&1

          echo ""
          echo "=== Latest Pages Build ==="
          gh api "repos/${{ github.repository }}/pages/builds/latest" 2>&1 || echo "No builds yet"

      - name: Wait and verify site
        run: |
          echo "Waiting 90s for Pages rebuild and CDN propagation..."
          sleep 90

          echo "=== Checking dailydealdarling.com ==="
          BODY_SIZE=$(curl -s https://dailydealdarling.com | wc -c)
          echo "Custom domain body size: ${BODY_SIZE} bytes"

          echo "=== Checking github.io ==="
          GH_SIZE=$(curl -s "https://talhahbilal1-arch.github.io/social-media-empire/" | wc -c)
          echo "github.io body size: ${GH_SIZE} bytes"

          if [ "$BODY_SIZE" -gt 5000 ]; then
            echo ""
            echo "SUCCESS: dailydealdarling.com is live! (${BODY_SIZE} bytes)"
          else
            echo ""
            echo "Site may still be propagating. Try again in a few minutes."
            echo "If still broken, go to Settings > Pages and re-enter dailydealdarling.com as custom domain."
          fi
