name: Setup Brand Sites on Vercel (run once)

on:
  workflow_dispatch:

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Deploy fitover35
        id: fitover35
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
        run: |
          cd outputs/fitover35-website
          # --name creates the project if it doesn't exist; VERCEL_ORG_ID scopes to the team
          vercel deploy --prod --yes --token $VERCEL_TOKEN --name fitover35-site 2>&1 | tee /tmp/fitover35.log
          DEPLOY_URL=$(grep -oE 'https://[^ ]+\.vercel\.app' /tmp/fitover35.log | tail -1)
          echo "Deploy URL: $DEPLOY_URL"
          # Fetch project ID by name
          PROJECT_ID=$(curl -s "https://api.vercel.com/v9/projects/fitover35-site?teamId=$VERCEL_ORG_ID" \
            -H "Authorization: Bearer $VERCEL_TOKEN" | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('id','NOT_FOUND'))")
          echo "fitover35_project_id=$PROJECT_ID" >> $GITHUB_OUTPUT
          echo "FitOver35 Project ID: $PROJECT_ID"

      - name: Deploy dailydealdarling
        id: deals
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
        run: |
          cd outputs/dailydealdarling-website
          vercel deploy --prod --yes --token $VERCEL_TOKEN --name daily-deal-darling 2>&1 | tee /tmp/deals.log
          DEPLOY_URL=$(grep -oE 'https://[^ ]+\.vercel\.app' /tmp/deals.log | tail -1)
          echo "Deploy URL: $DEPLOY_URL"
          PROJECT_ID=$(curl -s "https://api.vercel.com/v9/projects/daily-deal-darling?teamId=$VERCEL_ORG_ID" \
            -H "Authorization: Bearer $VERCEL_TOKEN" | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('id','NOT_FOUND'))")
          echo "deals_project_id=$PROJECT_ID" >> $GITHUB_OUTPUT
          echo "Daily Deal Darling Project ID: $PROJECT_ID"

      - name: Deploy menopause-planner
        id: menopause
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
        run: |
          cd outputs/menopause-planner-website
          vercel deploy --prod --yes --token $VERCEL_TOKEN --name menopause-planner 2>&1 | tee /tmp/menopause.log
          DEPLOY_URL=$(grep -oE 'https://[^ ]+\.vercel\.app' /tmp/menopause.log | tail -1)
          echo "Deploy URL: $DEPLOY_URL"
          PROJECT_ID=$(curl -s "https://api.vercel.com/v9/projects/menopause-planner?teamId=$VERCEL_ORG_ID" \
            -H "Authorization: Bearer $VERCEL_TOKEN" | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('id','NOT_FOUND'))")
          echo "menopause_project_id=$PROJECT_ID" >> $GITHUB_OUTPUT
          echo "Menopause Planner Project ID: $PROJECT_ID"

      - name: Print project IDs to summary
        if: always()
        run: |
          echo "## Brand Sites Deployed on Vercel" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Add these as GitHub repository secrets to enable auto-deploy from content-engine:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Name | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|" >> $GITHUB_STEP_SUMMARY
          echo "| VERCEL_FITOVER35_PROJECT_ID | ${{ steps.fitover35.outputs.fitover35_project_id }} |" >> $GITHUB_STEP_SUMMARY
          echo "| VERCEL_DEALS_PROJECT_ID | ${{ steps.deals.outputs.deals_project_id }} |" >> $GITHUB_STEP_SUMMARY
          echo "| VERCEL_MENOPAUSE_PROJECT_ID | ${{ steps.menopause.outputs.menopause_project_id }} |" >> $GITHUB_STEP_SUMMARY
