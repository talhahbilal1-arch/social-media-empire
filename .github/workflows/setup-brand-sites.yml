name: Setup Brand Sites on Vercel (run once)

on:
  workflow_dispatch:

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Deploy fitover35
        id: fitover35
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          set -o pipefail
          cd outputs/fitover35-website
          # No VERCEL_ORG_ID/VERCEL_PROJECT_ID set — CLI auto-creates the project
          vercel deploy --prod --yes --token $VERCEL_TOKEN 2>&1 | tee /tmp/fitover35.log
          DEPLOY_URL=$(grep -oE 'https://[^ ]+\.vercel\.app' /tmp/fitover35.log | tail -1)
          echo "Deploy URL: $DEPLOY_URL"
          echo "fitover35_url=$DEPLOY_URL" >> $GITHUB_OUTPUT

      - name: Deploy dailydealdarling
        id: deals
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          set -o pipefail
          cd outputs/dailydealdarling-website
          vercel deploy --prod --yes --token $VERCEL_TOKEN 2>&1 | tee /tmp/deals.log
          DEPLOY_URL=$(grep -oE 'https://[^ ]+\.vercel\.app' /tmp/deals.log | tail -1)
          echo "Deploy URL: $DEPLOY_URL"
          echo "deals_url=$DEPLOY_URL" >> $GITHUB_OUTPUT

      - name: Deploy menopause-planner
        id: menopause
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          set -o pipefail
          cd outputs/menopause-planner-website
          vercel deploy --prod --yes --token $VERCEL_TOKEN 2>&1 | tee /tmp/menopause.log
          DEPLOY_URL=$(grep -oE 'https://[^ ]+\.vercel\.app' /tmp/menopause.log | tail -1)
          echo "Deploy URL: $DEPLOY_URL"
          echo "menopause_url=$DEPLOY_URL" >> $GITHUB_OUTPUT

      - name: Lookup project IDs
        id: ids
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          # List all projects and find the 3 new ones by directory name
          PROJECTS=$(curl -s "https://api.vercel.com/v9/projects?limit=50" \
            -H "Authorization: Bearer $VERCEL_TOKEN")
          echo "Projects response (first 500 chars): ${PROJECTS:0:500}"

          F35_ID=$(echo "$PROJECTS" | python3 -c "
          import sys,json
          d=json.load(sys.stdin)
          for p in d.get('projects',[]):
              if p.get('name','') in ('fitover35-website','fitover35-site'):
                  print(p['id']); exit()
          print('NOT_FOUND')
          ")
          DEALS_ID=$(echo "$PROJECTS" | python3 -c "
          import sys,json
          d=json.load(sys.stdin)
          for p in d.get('projects',[]):
              if p.get('name','') in ('dailydealdarling-website','daily-deal-darling'):
                  print(p['id']); exit()
          print('NOT_FOUND')
          ")
          MENO_ID=$(echo "$PROJECTS" | python3 -c "
          import sys,json
          d=json.load(sys.stdin)
          for p in d.get('projects',[]):
              if p.get('name','') in ('menopause-planner-website','menopause-planner'):
                  print(p['id']); exit()
          print('NOT_FOUND')
          ")

          echo "fitover35_id=$F35_ID" >> $GITHUB_OUTPUT
          echo "deals_id=$DEALS_ID" >> $GITHUB_OUTPUT
          echo "menopause_id=$MENO_ID" >> $GITHUB_OUTPUT
          echo "FitOver35 ID: $F35_ID"
          echo "Deals ID: $DEALS_ID"
          echo "Menopause ID: $MENO_ID"

          # Also dump all project names for debugging
          echo "All projects:"
          echo "$PROJECTS" | python3 -c "
          import sys,json
          d=json.load(sys.stdin)
          for p in d.get('projects',[]):
              print(f'  {p[\"id\"]} — {p[\"name\"]}')
          "

      - name: Print project IDs to summary
        if: always()
        run: |
          echo "## Brand Sites Deployed on Vercel" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deploy URLs" >> $GITHUB_STEP_SUMMARY
          echo "- fitover35: ${{ steps.fitover35.outputs.fitover35_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- deals: ${{ steps.deals.outputs.deals_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- menopause: ${{ steps.menopause.outputs.menopause_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Add these as GitHub repository secrets:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Name | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|" >> $GITHUB_STEP_SUMMARY
          echo "| VERCEL_FITOVER35_PROJECT_ID | ${{ steps.ids.outputs.fitover35_id }} |" >> $GITHUB_STEP_SUMMARY
          echo "| VERCEL_DEALS_PROJECT_ID | ${{ steps.ids.outputs.deals_id }} |" >> $GITHUB_STEP_SUMMARY
          echo "| VERCEL_MENOPAUSE_PROJECT_ID | ${{ steps.ids.outputs.menopause_id }} |" >> $GITHUB_STEP_SUMMARY
