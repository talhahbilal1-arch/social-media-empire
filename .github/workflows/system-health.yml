name: System Health

on:
  schedule:
    # Every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        type: choice
        options:
          - full_check
          - health_only
          - self_heal
          - cleanup

env:
  PYTHON_VERSION: '3.11'

jobs:
  health-check:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      status: ${{ steps.check.outputs.status }}
      issues: ${{ steps.check.outputs.issues }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run health check
        id: check
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
          CREATOMATE_API_KEY: ${{ secrets.CREATOMATE_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          LATE_API_KEY: ${{ secrets.LATE_API_KEY }}
          LATE_API_KEY_3: ${{ secrets.LATE_API_KEY_3 }}
          CONVERTKIT_API_KEY: ${{ secrets.CONVERTKIT_API_KEY }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
        run: |
          python -c "
          import os
          import sys
          import json
          import requests
          from datetime import datetime

          issues = []
          status = 'healthy'

          # Check Anthropic API
          try:
              import anthropic
              client = anthropic.Anthropic(api_key=os.environ.get('ANTHROPIC_API_KEY', ''))
              resp = client.messages.create(
                  model='claude-sonnet-4-5-20250929',
                  max_tokens=10,
                  messages=[{'role': 'user', 'content': 'ping'}]
              )
              print('Anthropic API: OK')
          except Exception as e:
              issues.append(f'Anthropic API: {e}')
              status = 'degraded'

          # Check Pexels API
          try:
              key = os.environ.get('PEXELS_API_KEY', '')
              resp = requests.get('https://api.pexels.com/v1/search?query=test&per_page=1',
                                headers={'Authorization': key}, timeout=10)
              resp.raise_for_status()
              print('Pexels API: OK')
          except Exception as e:
              issues.append(f'Pexels API: {e}')
              status = 'degraded'

          # Check Supabase
          try:
              sys.path.insert(0, '.')
              from database.supabase_client import get_supabase_client
              db = get_supabase_client()
              print('Supabase: OK')
          except Exception as e:
              issues.append(f'Supabase: {e}')
              status = 'unhealthy'

          # Check Late API
          try:
              key = os.environ.get('LATE_API_KEY_3') or os.environ.get('LATE_API_KEY', '')
              if key:
                  resp = requests.get('https://api.late.app/v1/accounts',
                                    headers={'Authorization': f'Bearer {key}'}, timeout=10)
                  resp.raise_for_status()
                  print('Late API: OK')
              else:
                  issues.append('Late API: No key configured')
          except Exception as e:
              issues.append(f'Late API: {e}')
              status = 'degraded'

          if issues:
              print(f'\nIssues found ({len(issues)}):')
              for i in issues:
                  print(f'  - {i}')

          # Write outputs
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f'status={status}\n')
              f.write(f'issues={json.dumps(issues)}\n')

          print(f'\nOverall status: {status}')
          "

  self-heal:
    runs-on: ubuntu-latest
    needs: health-check
    if: >
      needs.health-check.outputs.status != 'healthy' ||
      github.event.inputs.action == 'self_heal' ||
      github.event.inputs.action == 'full_check'
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Attempt self-healing
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          python -c "
          import sys
          sys.path.insert(0, '.')
          from database.supabase_client import get_supabase_client
          from datetime import datetime, timedelta

          db = get_supabase_client()

          # Retry failed pins from last 24 hours
          try:
              yesterday = (datetime.utcnow() - timedelta(hours=24)).isoformat()
              errors = db.client.table('errors').select('*') \
                  .eq('error_type', 'content_engine') \
                  .gte('created_at', yesterday) \
                  .execute()
              if errors.data:
                  print(f'Found {len(errors.data)} content engine errors in last 24h')
                  # Mark as reviewed
                  for err in errors.data:
                      db.client.table('errors').update({'resolved': True}) \
                          .eq('id', err['id']).execute()
              else:
                  print('No recent content engine errors')
          except Exception as e:
              print(f'Self-healing error check failed: {e}')

          # Clean old data
          try:
              cutoff_30d = (datetime.utcnow() - timedelta(days=30)).isoformat()
              cutoff_90d = (datetime.utcnow() - timedelta(days=90)).isoformat()
              db.client.table('errors').delete() \
                  .eq('resolved', True) \
                  .lt('created_at', cutoff_30d).execute()
              print('Cleaned resolved errors older than 30 days')
          except Exception as e:
              print(f'Cleanup failed: {e}')
          "

  alert:
    runs-on: ubuntu-latest
    needs: health-check
    if: needs.health-check.outputs.status == 'unhealthy'
    timeout-minutes: 5

    steps:
      - name: Send alert
        env:
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          ALERT_EMAIL: ${{ secrets.ALERT_EMAIL }}
        run: |
          python -c "
          import os
          import resend

          resend_key = os.environ.get('RESEND_API_KEY', '')
          alert_email = os.environ.get('ALERT_EMAIL', '')

          if not resend_key or not alert_email:
              print('Alert email not configured')
              exit(0)

          resend.api_key = resend_key
          resend.Emails.send({
              'from': 'alerts@socialmediaempire.com',
              'to': [alert_email],
              'subject': 'UNHEALTHY: Social Media Empire System Alert',
              'html': '<h1>System Health Alert</h1><p>Status: UNHEALTHY</p><p>Issues: ${{ needs.health-check.outputs.issues }}</p><p>Check GitHub Actions for details.</p>'
          })
          print('Alert sent')
          "
