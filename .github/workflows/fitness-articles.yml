name: Fitness & Deals Articles

on:
  schedule:
    # Daily at 11 PM PST (7 AM UTC), Mon-Fri
    - cron: '0 7 * * 1-5'
  workflow_dispatch:
    inputs:
      brand:
        description: 'Brand (fitover35 or deals)'
        type: choice
        options:
          - fitover35
          - deals
          - both
        default: fitover35
      keyword:
        description: 'Target keyword (optional - auto-select if empty)'
        type: string
        required: false

permissions:
  contents: write

env:
  PYTHON_VERSION: '3.11'

jobs:
  generate-fitover35-article:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    # Always run for fitover35
    if: >
      github.event.inputs.brand != 'deals' ||
      github.event_name == 'schedule'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Select keyword
        id: keyword
        run: |
          if [ -n "${{ github.event.inputs.keyword }}" ]; then
            KEYWORD="${{ github.event.inputs.keyword }}"
            SLUG=$(echo "$KEYWORD" | tr '[:upper:]' '[:lower:]' | tr ' ' '-' | tr -cd 'a-z0-9-' | cut -c1-60)
            FILENAME="${SLUG}.html"
            echo "keyword=$KEYWORD" >> $GITHUB_OUTPUT
            echo "category=auto" >> $GITHUB_OUTPUT
            echo "slug=$SLUG" >> $GITHUB_OUTPUT
            echo "filename=$FILENAME" >> $GITHUB_OUTPUT
          else
            python automation/articles/fitover35_keywords.py \
              --mark-used \
              --state-file fitover35_keyword_state.json
          fi

      - name: Generate article
        id: generate
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
        run: |
          KEYWORD="${{ steps.keyword.outputs.keyword }}"
          CATEGORY="${{ steps.keyword.outputs.category }}"
          SLUG="${{ steps.keyword.outputs.slug }}"
          FILENAME="${{ steps.keyword.outputs.filename }}"

          echo "Generating FitOver35 article for: $KEYWORD"

          python automation/articles/fitover35_article_generator.py \
            --keyword "$KEYWORD" \
            --category "$CATEGORY" \
            --output "outputs/fitover35-website/articles/$FILENAME"

      - name: Update blog listing
        run: |
          python automation/articles/update_blog_index.py \
            --brand fitover35 \
            --article-path "articles/${{ steps.keyword.outputs.filename }}" \
            --title "${{ steps.generate.outputs.title }}" \
            --category "${{ steps.generate.outputs.category }}" \
            --excerpt "${{ steps.generate.outputs.excerpt }}" \
            --read-time "${{ steps.generate.outputs.read_time }}" \
            --image-url "${{ steps.generate.outputs.hero_image }}"

      - name: Commit and push
        run: |
          git config user.name "FitOver35 Bot"
          git config user.email "bot@fitover35.com"
          git add outputs/fitover35-website/articles/
          git add outputs/fitover35-website/blog.html
          git add fitover35_keyword_state.json || true

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            TITLE="${{ steps.generate.outputs.title }}"
            git commit -m "Publish FitOver35 article: ${TITLE}"
            git push
          fi

      - name: Summary
        run: |
          echo "## FitOver35 Article Published" >> $GITHUB_STEP_SUMMARY
          echo "**Title:** ${{ steps.generate.outputs.title }}" >> $GITHUB_STEP_SUMMARY
          echo "**Keyword:** ${{ steps.keyword.outputs.keyword }}" >> $GITHUB_STEP_SUMMARY

  generate-deals-article:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    # Only run on Mon/Wed/Fri for deals
    if: >
      github.event.inputs.brand == 'deals' ||
      github.event.inputs.brand == 'both' ||
      (github.event_name == 'schedule' && (
        contains('1,3,5', github.event.schedule)
      ))

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Generate deals article
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
        run: |
          python -c "
          import sys
          sys.path.insert(0, '.')

          # Placeholder for deals article generation
          # Will use Claude API to generate lifestyle/home articles
          print('Deals article generation - to be implemented')
          print('Will generate articles for dailydealdarling.com')
          "

      - name: Summary
        run: |
          echo "## Daily Deal Darling Article" >> $GITHUB_STEP_SUMMARY
          echo "Deals article generation placeholder" >> $GITHUB_STEP_SUMMARY
