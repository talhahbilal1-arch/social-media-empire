name: Fitness Email Sequence Processor

on:
  schedule:
    # Run daily at 10 AM PST (6 PM UTC) to process welcome sequence emails
    - cron: '0 18 * * *'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Preview emails without sending'
        required: false
        type: boolean
        default: false

env:
  PYTHON_VERSION: '3.11'

jobs:
  process-email-sequences:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Process welcome sequences
        env:
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          CONVERTKIT_API_KEY: ${{ secrets.CONVERTKIT_API_KEY }}
          CONVERTKIT_API_SECRET: ${{ secrets.CONVERTKIT_API_SECRET }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          python -c "
          import sys
          sys.path.insert(0, '.')
          from email_marketing.sequences.fitnessmadeasy_welcome import WELCOME_SEQUENCE
          print('=== FitOver35 Welcome Sequence ===')
          print(f'Total emails in sequence: {len(WELCOME_SEQUENCE)}')
          for email in WELCOME_SEQUENCE:
              print(f'  Email {email[\"email_number\"]}: \"{email[\"subject\"]}\" (Day {email[\"delay_days\"]})')
          print()
          print('Sequence is configured and ready.')
          print('Note: ConvertKit handles actual send timing via automations.')
          print('This workflow verifies sequence integrity and syncs any updates.')
          "

          echo ""
          echo "## Email Sequence Status" >> $GITHUB_STEP_SUMMARY
          echo "- Sequence: FitOver35 Welcome (7 emails over 14 days)" >> $GITHUB_STEP_SUMMARY
          echo "- Status: Active" >> $GITHUB_STEP_SUMMARY
          echo "- Delivery: Via ConvertKit automation" >> $GITHUB_STEP_SUMMARY
