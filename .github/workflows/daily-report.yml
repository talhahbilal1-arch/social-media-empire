name: Daily Report

on:
  # Daily report now only generates data for weekly summary - no daily emails
  schedule:
    # Run at 9 PM PST (5 AM UTC next day) to summarize the day
    - cron: '0 5 * * *'
  workflow_dispatch:
    inputs:
      date:
        description: 'Report date (YYYY-MM-DD)'
        required: false
        type: string
      send_email:
        description: 'Send report via email (disabled by default - use weekly summary)'
        required: false
        type: boolean
        default: false

env:
  PYTHON_VERSION: '3.11'

jobs:
  generate-report:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Generate daily report
        id: report
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          ALERT_EMAIL: ${{ secrets.ALERT_EMAIL }}
        run: |
          ARGS=""
          if [ "${{ github.event.inputs.date }}" != "" ]; then
            ARGS="--date ${{ github.event.inputs.date }}"
          fi

          # Only send email if manually requested (weekly summary handles regular emails now)
          if [ "${{ github.event.inputs.send_email }}" == "true" ]; then
            ARGS="$ARGS --send"
          fi

          python -m monitoring.daily_report_generator $ARGS --json > daily_report.json

          # Extract health score for summary
          SCORE=$(python -c "import json; data=json.load(open('daily_report.json')); print(data.get('health_score', 0))")
          echo "health_score=$SCORE" >> $GITHUB_OUTPUT

      - name: Upload report
        uses: actions/upload-artifact@v4
        with:
          name: daily-report-${{ github.run_number }}
          path: daily_report.json
          retention-days: 90

      - name: Create summary
        run: |
          python -c "
          import json

          with open('daily_report.json', 'r') as f:
              report = json.load(f)

          score = report.get('health_score', 0)
          videos = report.get('videos', {})
          email = report.get('email', {})
          errors = report.get('errors', {})

          print(f'## Daily Report Summary')
          print(f'')
          print(f'**Date:** {report.get(\"date\", \"Unknown\")}')
          print(f'**Health Score:** {score}/100')
          print(f'')
          print(f'### Videos')
          print(f'- Created: {videos.get(\"created\", 0)}/{videos.get(\"target\", 12)}')
          print(f'- Completion: {videos.get(\"completion_rate\", 0):.0f}%')
          print(f'')
          print(f'### Email')
          print(f'- New Subscribers: {email.get(\"new_subscribers\", 0)}')
          print(f'')
          print(f'### Errors')
          print(f'- Today: {errors.get(\"total_today\", 0)}')
          print(f'- Unresolved: {errors.get(\"total_unresolved\", 0)}')
          " >> $GITHUB_STEP_SUMMARY

    outputs:
      health_score: ${{ steps.report.outputs.health_score }}

  weekly-summary:
    runs-on: ubuntu-latest
    # Run on Sundays
    if: github.event_name == 'schedule'
    needs: generate-report
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Check if Sunday
        id: day
        run: |
          DAY=$(date +%u)
          if [ "$DAY" -eq "7" ]; then
            echo "is_sunday=true" >> $GITHUB_OUTPUT
          else
            echo "is_sunday=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate weekly summary
        if: steps.day.outputs.is_sunday == 'true'
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          ALERT_EMAIL: ${{ secrets.ALERT_EMAIL }}
        run: |
          python -c "
          from datetime import datetime, timedelta
          from monitoring.daily_report_generator import DailyReportGenerator

          generator = DailyReportGenerator()

          # Generate reports for past 7 days
          weekly_data = []
          for i in range(7):
              date = (datetime.now() - timedelta(days=i)).strftime('%Y-%m-%d')
              report = generator.generate_report(date)
              weekly_data.append(report)

          # Calculate averages
          avg_score = sum(r.get('health_score', 0) for r in weekly_data) / len(weekly_data)
          total_videos = sum(r.get('videos', {}).get('created', 0) for r in weekly_data)
          total_subscribers = sum(r.get('email', {}).get('new_subscribers', 0) for r in weekly_data)

          print(f'Weekly Summary:')
          print(f'  Average Health Score: {avg_score:.0f}/100')
          print(f'  Total Videos: {total_videos}')
          print(f'  New Subscribers: {total_subscribers}')
          "
