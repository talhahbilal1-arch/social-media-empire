#!/usr/bin/env node
/**
 * ToolPilot Weekly Newsletter Generator
 * Reads recent content + newsletter highlights, generates a weekly digest via Claude API.
 *
 * Usage:
 *   ANTHROPIC_API_KEY=xxx node scripts/generate-newsletter.js
 *   ANTHROPIC_API_KEY=xxx node scripts/generate-newsletter.js --output /tmp/newsletter.json
 */

const fs = require('fs')
const path = require('path')
const https = require('https')

const ANTHROPIC_API_KEY = process.env.ANTHROPIC_API_KEY
const SITE_URL = 'https://toolpilot-hub.netlify.app'

// Parse CLI args
const args = process.argv.slice(2)
const outputIdx = args.indexOf('--output')
const outputPath = outputIdx !== -1 && args[outputIdx + 1]
  ? args[outputIdx + 1]
  : path.join(__dirname, '..', 'content', 'newsletter-latest.json')

// Load content files
const tools = require('../content/tools.json')
const comparisons = require('../content/comparisons.json')
const articles = require('../content/articles.json')

// Load newsletter highlights (generated by discover-ai-trends.js)
const highlightsPath = path.join(__dirname, '..', 'config', 'newsletter-highlights.json')
let highlights = {}
try {
  highlights = JSON.parse(fs.readFileSync(highlightsPath, 'utf8'))
} catch {
  console.log('No newsletter-highlights.json found — using content files only.')
}

async function callClaude(prompt, maxTokens = 4000) {
  return new Promise((resolve, reject) => {
    const data = JSON.stringify({
      model: 'claude-sonnet-4-5-20250929',
      max_tokens: maxTokens,
      messages: [{ role: 'user', content: prompt }]
    })

    const options = {
      hostname: 'api.anthropic.com',
      path: '/v1/messages',
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': ANTHROPIC_API_KEY,
        'anthropic-version': '2023-06-01',
        'Content-Length': Buffer.byteLength(data)
      }
    }

    const req = https.request(options, (res) => {
      let body = ''
      res.on('data', chunk => body += chunk)
      res.on('end', () => {
        try {
          const parsed = JSON.parse(body)
          if (parsed.content && parsed.content[0]) {
            resolve(parsed.content[0].text)
          } else {
            reject(new Error(`Unexpected API response: ${body.substring(0, 300)}`))
          }
        } catch (e) {
          reject(new Error(`Failed to parse API response: ${e.message}`))
        }
      })
    })

    req.on('error', reject)
    req.write(data)
    req.end()
  })
}

async function main() {
  if (!ANTHROPIC_API_KEY) {
    console.error('Error: ANTHROPIC_API_KEY environment variable is required')
    process.exit(1)
  }

  // Get recent content (last 7 days)
  const oneWeekAgo = new Date()
  oneWeekAgo.setDate(oneWeekAgo.getDate() - 7)
  const recentDate = oneWeekAgo.toISOString().split('T')[0]

  const recentArticles = articles
    .filter(a => a.published_date >= recentDate)
    .slice(0, 5)

  const recentComparisons = comparisons.slice(-5)

  // Build newest tools (last 5 added)
  const newestTools = tools.slice(-5)

  const weekOf = new Date().toLocaleDateString('en-US', {
    month: 'long', day: 'numeric', year: 'numeric'
  })

  const prompt = `Generate a weekly newsletter for ToolPilot AI Tools, themed "Make Money & Save Money with AI."

Week of: ${weekOf}
Site URL: ${SITE_URL}

RECENT CONTENT ON TOOLPILOT:
${recentArticles.length > 0 ? `Articles:\n${recentArticles.map(a => `- "${a.title}" — ${a.excerpt || ''} (${SITE_URL}/blog/${a.slug}/)`).join('\n')}` : 'No new articles this week.'}

Recent comparisons:
${recentComparisons.map(c => `- ${c.title} (${SITE_URL}/compare/${c.slug}/)`).join('\n')}

New tool reviews:
${newestTools.map(t => `- ${t.name}: ${t.tagline} — ${t.rating}/5, ${t.pricing.free_tier ? 'free tier available' : '$' + t.pricing.starting_price + '/mo'} (${SITE_URL}/tools/${t.slug}/)`).join('\n')}

${highlights.trending_topic ? `TRENDING THIS WEEK: ${highlights.trending_topic}` : ''}
${highlights.money_tip ? `MONEY TIP: ${highlights.money_tip}` : ''}
${highlights.free_tool_spotlight ? `FREE TOOL SPOTLIGHT: ${highlights.free_tool_spotlight}` : ''}

Write the newsletter with these sections:
1. **AI Money Maker of the Week** — One specific way to make money with an AI tool this week
2. **Free Tool Spotlight** — Highlight one tool with a great free tier
3. **Quick Comparison** — Summarize the most interesting comparison with a clear winner
4. **Money-Saving Tip** — A practical tip for saving money with AI tools
5. **New on ToolPilot** — 2-3 bullet points linking to new content

RULES:
- Write in a friendly, concise, actionable tone
- Use HTML formatting (h2, p, ul/li, a, strong)
- Include real links to ${SITE_URL}/tools/slug/ and ${SITE_URL}/compare/slug/ and ${SITE_URL}/blog/slug/
- Keep total length under 600 words
- Include a CTA to visit ToolPilot at the end

Return ONLY valid JSON:
{
  "subject": "catchy subject line under 60 chars with money/AI angle + ${weekOf}",
  "preview_text": "40-60 char preview text",
  "html_content": "<h2>AI Money Maker of the Week</h2><p>...</p>..."
}`

  console.log('Generating weekly newsletter via Claude...')
  const response = await callClaude(prompt)

  // Extract JSON
  const match = response.match(/\{[\s\S]*\}/)
  if (!match) {
    console.error('Failed to extract JSON from response')
    process.exit(1)
  }

  const newsletter = JSON.parse(match[0])
  newsletter.generated_at = new Date().toISOString()
  newsletter.week_of = weekOf

  fs.writeFileSync(outputPath, JSON.stringify(newsletter, null, 2))
  console.log(`Newsletter generated: "${newsletter.subject}"`)
  console.log(`Output: ${outputPath}`)
}

main().catch(err => {
  console.error('Fatal error:', err.message)
  process.exit(1)
})
