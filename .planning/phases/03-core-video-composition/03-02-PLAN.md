---
phase: 03-core-video-composition
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/video/text_overlay.py
autonomous: true

must_haves:
  truths:
    - "Text overlays use brand-specific colors from BrandConfig"
    - "Text is positioned within 120px safe zones from all edges"
    - "Text clips have start time and duration for synchronization"
  artifacts:
    - path: "src/video/text_overlay.py"
      provides: "TextClip factory with safe zone positioning"
      exports: ["create_text_overlay", "TextOverlayConfig"]
      min_lines: 80
  key_links:
    - from: "src/video/text_overlay.py"
      to: "moviepy TextClip"
      via: "TextClip import"
      pattern: "from moviepy import TextClip"
    - from: "src/video/text_overlay.py"
      to: "src/models/brand.py"
      via: "BrandConfig colors"
      pattern: "brand_config\\.colors"
---

<objective>
Create the text overlay system with safe zone positioning and brand color integration.

Purpose: Text overlays are the primary visual content element in these videos. They must be readable, properly positioned to avoid mobile UI elements (profile icons, like buttons), and styled with brand colors for consistency.

Output: `src/video/text_overlay.py` with `create_text_overlay()` function and supporting configuration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-video-composition/03-RESEARCH.md
@src/models/brand.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create text_overlay module with configuration</name>
  <files>src/video/text_overlay.py</files>
  <action>
Create `src/video/text_overlay.py` with:

1. Module-level constants (same as compositor for consistency):
```python
VIDEO_WIDTH = 1080
VIDEO_HEIGHT = 1920
SAFE_ZONE_MARGIN = 120  # 120px from edges per roadmap requirements
```

2. Imports using MoviePy 2.0 syntax:
```python
from typing import Literal, Optional
from dataclasses import dataclass
from moviepy import TextClip
from src.models.brand import BrandConfig
```

3. TextOverlayConfig dataclass for configuration:
```python
@dataclass
class TextOverlayConfig:
    """Configuration for text overlay appearance."""
    font_size: int = 64
    stroke_width: int = 3
    margin: tuple[int, int] = (5, 5)  # Prevent stroke cutoff
    text_align: str = 'center'
```

4. Position type hint:
```python
PositionType = Literal["top", "center", "bottom"]
```
  </action>
  <verify>
```bash
python -c "
from src.video.text_overlay import TextOverlayConfig, VIDEO_WIDTH, VIDEO_HEIGHT, SAFE_ZONE_MARGIN
config = TextOverlayConfig()
print(f'Default font_size: {config.font_size}')
print(f'VIDEO_WIDTH: {VIDEO_WIDTH}')
print(f'SAFE_ZONE_MARGIN: {SAFE_ZONE_MARGIN}')
"
```
  </verify>
  <done>text_overlay.py exists with TextOverlayConfig dataclass and constants</done>
</task>

<task type="auto">
  <name>Task 2: Implement create_text_overlay function with safe zone positioning</name>
  <files>src/video/text_overlay.py</files>
  <action>
Add the main factory function:

```python
def create_text_overlay(
    text: str,
    start_time: float,
    duration: float,
    brand_config: BrandConfig,
    position: PositionType = "center",
    config: Optional[TextOverlayConfig] = None
) -> TextClip:
    """Create a text overlay clip with brand colors and safe zone positioning.

    Args:
        text: Text content to display
        start_time: When the text appears (seconds)
        duration: How long the text is visible (seconds)
        brand_config: Brand configuration for colors
        position: Vertical position - "top", "center", or "bottom"
        config: Optional override for text styling

    Returns:
        TextClip positioned within safe zones with brand styling

    Note:
        Uses absolute coordinate positioning (not string positions like "center")
        due to known bugs in MoviePy 2.x with string-based positioning.
    """
```

Implementation:
1. Use default config if not provided: `config = config or TextOverlayConfig()`

2. Extract colors from brand_config. The Color type has .as_hex() method:
```python
text_color = brand_config.colors.secondary.as_hex()
stroke_color = brand_config.colors.primary.as_hex()
```

3. Create TextClip with Pillow (default in MoviePy 2.x):
```python
txt_clip = TextClip(
    text=text,
    font_size=config.font_size,
    color=text_color,
    stroke_color=stroke_color,
    stroke_width=config.stroke_width,
    method='caption',  # Auto-wrap text to fit width
    size=(VIDEO_WIDTH - 2 * SAFE_ZONE_MARGIN, None),  # Width constrained, auto height
    text_align=config.text_align,
    margin=config.margin
)
```

4. Calculate absolute Y position based on position parameter:
```python
if position == "top":
    y_pos = SAFE_ZONE_MARGIN
elif position == "bottom":
    y_pos = VIDEO_HEIGHT - SAFE_ZONE_MARGIN - txt_clip.h
else:  # center
    y_pos = (VIDEO_HEIGHT - txt_clip.h) / 2

x_pos = SAFE_ZONE_MARGIN  # Centered horizontally within safe zone
```

5. Apply position and timing:
```python
txt_clip = txt_clip.with_position((x_pos, y_pos))
txt_clip = txt_clip.with_start(start_time)
txt_clip = txt_clip.with_duration(duration)
```

6. Return the clip

CRITICAL: Use `.with_position((x, y))` with tuple coordinates, NOT `.with_position("center")` - string positions have bugs in MoviePy 2.x (see research Pattern 2).
  </action>
  <verify>
```bash
python -c "
from src.video.text_overlay import create_text_overlay, TextOverlayConfig
from src.models.brand import BrandConfig, ColorPalette
from pydantic_extra_types.color import Color

brand = BrandConfig(
    name='Test', slug='test',
    colors=ColorPalette(primary=Color('#4A7C59'), secondary=Color('#D4A5A5')),
    tts_voice='en-US-JennyNeural', cta_text='Test', cta_url='https://test.com'
)

# Test creating a text overlay (won't render, just checks it doesn't error)
clip = create_text_overlay(
    text='Hello World',
    start_time=0.0,
    duration=2.0,
    brand_config=brand,
    position='center'
)
print(f'TextClip created: {type(clip).__name__}')
clip.close()
print('Test passed')
"
```
  </verify>
  <done>create_text_overlay function returns TextClip with brand colors and safe zone positioning</done>
</task>

<task type="auto">
  <name>Task 3: Update video module exports</name>
  <files>src/video/__init__.py</files>
  <action>
Update `src/video/__init__.py` to export text overlay components:

```python
from src.video.compositor import VideoCompositor
from src.video.text_overlay import create_text_overlay, TextOverlayConfig

__all__ = [
    "VideoCompositor",
    "create_text_overlay",
    "TextOverlayConfig",
]
```

Note: This task depends on Plan 01 completing first if run in parallel. If running sequentially, VideoCompositor import should work. If Plan 01 hasn't run yet, the import will fail - that's expected and will be resolved when Plan 01 completes.
  </action>
  <verify>
```bash
python -c "
from src.video import create_text_overlay, TextOverlayConfig
print('Exports work')
"
```
  </verify>
  <done>src/video/__init__.py exports create_text_overlay and TextOverlayConfig</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Text overlay creates with brand colors:
```bash
python -c "
from src.video.text_overlay import create_text_overlay
from src.models.brand import BrandConfig, ColorPalette
from pydantic_extra_types.color import Color

brand = BrandConfig(
    name='Test', slug='test',
    colors=ColorPalette(primary=Color('#4A7C59'), secondary=Color('#D4A5A5')),
    tts_voice='en-US-JennyNeural', cta_text='Test', cta_url='https://test.com'
)

for pos in ['top', 'center', 'bottom']:
    clip = create_text_overlay('Test text', 0.0, 1.0, brand, position=pos)
    # Position should be tuple, not string
    print(f'{pos}: position set')
    clip.close()
print('All positions work')
"
```

2. Safe zone constraints applied:
```bash
python -c "
from src.video.text_overlay import VIDEO_WIDTH, VIDEO_HEIGHT, SAFE_ZONE_MARGIN
assert VIDEO_WIDTH == 1080
assert VIDEO_HEIGHT == 1920
assert SAFE_ZONE_MARGIN == 120
print('Safe zone constants correct')
"
```
</verification>

<success_criteria>
- src/video/text_overlay.py exists with create_text_overlay function
- TextOverlayConfig dataclass provides customizable styling
- create_text_overlay accepts BrandConfig and extracts colors correctly
- Position is calculated using absolute coordinates (tuple), not strings
- Safe zone margin of 120px is applied to text width and positioning
- Text clips have proper start_time and duration set
- All imports use MoviePy 2.0 syntax
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-video-composition/03-02-SUMMARY.md`
</output>
